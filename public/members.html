<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>æˆå“¡ VC ç”¢ç”Ÿå™¨ï½œRWA Housing Governance MVP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>

    

    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"; margin:24px; line-height:1.6; background:#f9fafb; }
    .container { max-width:1200px; margin:0 auto; }
    .card { border:1px solid #e5e7eb; border-radius:12px; padding:20px; margin:16px 0; background:white; box-shadow:0 1px 3px rgba(0,0,0,0.1); }
    .card h3 { margin-top:0; color:#1f2937; }
    label { display:block; margin:10px 0 4px; }
    input, select, button, textarea { font-size:16px; }
    input, select, textarea { width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius:8px; }
    textarea { min-height: 140px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }
    .row { display:flex; gap:12px; }
    .row > div { flex:1; }
    .actions { display:flex; flex-wrap:wrap; gap:10px; margin-top:12px; }
    .hint { color:#6b7280; font-size: 13px; }
  </style>
</head>
<body>
  <div class="container">
    <div style="margin-bottom:24px;">
      <h1 style="margin:0 0 8px 0; font-size:28px; color:#1f2937;">ğŸ—ï¸ Core Flow ï½œ æˆå“¡ VC ç”¢ç”Ÿå™¨</h1>
      <p class="hint" style="color:#6b7280; margin:0; font-size:14px;">æˆ¿å®¢ / æˆ¿æ± / å…¬è­‰ / éŠ€è¡Œèº«ä»½é©—è­‰æ†‘è­‰</p>
    </div>
<div class="card" id="flow-wizard">
    <label style="margin-top:0;">æˆ‘è¦æ¸¬è©¦å“ªä¸€æ¢é©—è­‰æµç¨‹ï¼Ÿ</label>
    <div style="display:flex;gap:16px;flex-wrap:wrap;">
      <label><input type="radio" name="flow" value="A" checked> Aï¼šæˆå“¡ VC ç™¼è¡Œï¼ˆç•™åœ¨æœ¬é ï¼‰</label>
      <label><input type="radio" name="flow" value="B"> Bï¼šæ—¥èªŒé©—éˆï¼ˆverify.htmlï¼‰</label>
      <label><input type="radio" name="flow" value="C"> Cï¼šæ’¥æ¬¾å‰æ ¸é©—ï¼ˆpayout_verify.htmlï¼‰</label>
    </div>
    <div class="actions" style="margin-top:12px;">
      <button id="btnStartFlow" type="button">é–‹å§‹</button>
      <span id="flowHint" class="hint"></span>
    </div>
  </div>
  <div class="card">
    <div class="row">
      <div>
        <label>èº«åˆ†è§’è‰²ï¼ˆroleï¼‰</label>
        <select id="role">
          <option value="tenant">æˆ¿å®¢ tenant</option>
          <option value="landlord">æˆ¿æ± landlord</option>
          <option value="notary">å…¬è­‰äºº notary</option>
          <option value="bank">éŠ€è¡Œ bank</option>
        </select>
      </div>
      <div>
        <label>ä¸»é«”åç¨±ï¼ˆsubjectï¼‰</label>
        <input id="subject" placeholder="ä¾‹å¦‚ï¼šå¼µä¸‰ / æˆ–æ©Ÿæ§‹åç¨±" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>ç°½ç™¼è€…ï¼ˆissuerï¼‰</label>
        <input id="issuer" value="RWA-Housing-Governance-MVP" />
        <div class="hint">å¯ç”¨çµ„ç¹”åç¨±æˆ–ä½ çš„è­˜åˆ¥ï¼ˆä¾‹å¦‚ admin@rwaï¼‰</div>
      </div>
      <div>
        <label>åˆ°æœŸï¼ˆexpires_atï¼Œå¯é¸ï¼‰</label>
        <input id="expires" type="date" />
      </div>
    </div>

    <div class="actions">
      <button id="btnMake">â‘  ç”¢ç”Ÿ VC ä¸¦ä¸‹è¼‰</button>
      <button id="btnExportLog" type="button">â‘¡ åŒ¯å‡ºå¯©è¨ˆæ—¥èªŒï¼ˆaudit_log.jsonlï¼‰</button>
      <button id="btnReceipt" type="button">â‘¢ åŒ¯å‡º VC ç°½ç« å›åŸ·</button>

      <label class="hint">ï¼ˆå¯é‡è¤‡ä¸‹è¼‰ï¼›æ—¥èªŒæš«å­˜åœ¨ç€è¦½å™¨ localStorageï¼‰</label>
    </div>
  </div>

  <div class="card">
    <label>ç”¢ç”Ÿçµæœï¼ˆVC JSONï¼‰</label>
    <textarea id="vcOut" readonly></textarea>
  </div>

  </div>
  <!-- å°è¦½åˆ—æ”¾é€™è£¡ï¼ˆä¾ä½ çš„æ…£ä¾‹ï¼‰ -->
  <div id="statusSummary"></div>
  <div id="nav"></div>
  <script src="js/nav.js?v=20251031v4v3"></script>
  <script src="js/statusSummary.js"></script>

  <script>

(function fixJsonlNewlines(){
  const buf = localStorage.getItem('audit_log_jsonl') || '';
  if (buf.includes('\\n{') || buf.includes('}\\n')) {
    localStorage.setItem('audit_log_jsonl', buf.replace(/\\n/g, '\n'));
  }
})();

  // ========= 0) å°å¹«æ‰‹ï¼šæ™‚é–“ / éš¨æ©Ÿ / 16é€²ä½ =========
  const nowISO = () => new Date().toISOString();
  const rnd = (len=8) => Array.from(crypto.getRandomValues(new Uint8Array(len)))
                          .map(b=>b.toString(16).padStart(2,'0')).join('');

  // ========= 1) ç©©å®šåºåˆ—åŒ–ï¼škey æ’åºï¼Œé¿å…ä¸åŒç€è¦½å™¨é †åºä¸ä¸€è‡´ =========
  function stableStringify(obj){
    if (obj === null || typeof obj !== 'object') return JSON.stringify(obj);
    if (Array.isArray(obj)) return '[' + obj.map(stableStringify).join(',') + ']';
    const keys = Object.keys(obj).sort();
    return '{' + keys.map(k => JSON.stringify(k) + ':' + stableStringify(obj[k])).join(',') + '}';
  }

  // ========= 2) SHA-256ï¼ˆWeb Cryptoï¼‰ï¼Œè¼¸å‡ºåå…­é€²ä½ =========
  async function sha256Hex(str){
    const data = new TextEncoder().encode(str);
    const dig = await crypto.subtle.digest('SHA-256', data);
    return Array.from(new Uint8Array(dig)).map(b => b.toString(16).padStart(2,'0')).join('');
  }

  // ========= 3) è®€å¯«å¯©è¨ˆæ—¥èªŒï¼ˆå­˜ localStorageï¼Œä¹‹å¾Œå¯åŒ¯å‡ºç‚º .jsonlï¼‰=========
  const LOG_KEY = 'audit_log_jsonl';

  function appendAudit(lineObj){
    let buf = localStorage.getItem(LOG_KEY) || '';
    const line = JSON.stringify(lineObj);

    buf += (buf && !buf.endsWith('\n') ? '\n' : '') + line + '\n';
    localStorage.setItem(LOG_KEY, buf);
  }

  function exportAudit(){
    const buf = localStorage.getItem(LOG_KEY) || '';
    const blob = new Blob([buf], {type:'application/jsonl;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'audit_log.jsonl';
    a.click();
    URL.revokeObjectURL(a.href);
  }
  function readAuditLines(){
  const buf = localStorage.getItem(LOG_KEY) || '';
  if (!buf) return [];
  const rows = buf.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
  try {
    return rows.map(s => JSON.parse(s));
  } catch (e) {
    // é€²éšä¿éšªï¼šè‹¥ä¸­é€”æœ‰å£è¡Œï¼Œå…ˆæ¨™è¨˜ä¸¦ç•¥éï¼Œé¿å…æ•´å€‹åŠŸèƒ½æ›æ‰
    const good = [];
    for (const s of rows) {
      try { good.push(JSON.parse(s)); } catch(_) { /* å¿½ç•¥å£è¡Œ */ }
    }
    return good;
  }
}
// ä»¥å›ºå®šæ¬„ä½é †åºåš record_hashï¼Œé¿å…ä¸åŒç€è¦½å™¨éµé †åºå·®ç•°
async function calcRecordHash(o){
  const plain = JSON.stringify({
    ts:o.ts, actor:o.actor, action:o.action, ref:o.ref, data_hash:o.data_hash, prev_hash:o.prev_hash
  });
  return await sha256Hex(plain);
}

  // ========= 4) ç”¢ç”Ÿ VC + ä¸‹è¼‰ + å¯«ä¸€è¡Œæ—¥èªŒ =========
  document.getElementById('btnMake').addEventListener('click', async () => {
    const role = document.getElementById('role').value.trim();
    const subject = document.getElementById('subject').value.trim();
    const issuer = document.getElementById('issuer').value.trim();
    const expires = document.getElementById('expires').value ? 
                    (new Date(document.getElementById('expires').value).toISOString()) : null;
            if (!role) { alert('è«‹é¸æ“‡èº«åˆ†è§’è‰²'); return; }
if(!subject){ alert('è«‹è¼¸å…¥ä¸»é«”åç¨±ï¼ˆsubjectï¼‰'); return; }
  
    const payload = {
      subject, role, issuer,
      issued_at: nowISO(),
      expires_at: expires
    };
    const payloadStr = stableStringify(payload);
    const payload_hash = await sha256Hex(payloadStr);
    const vc = {
      type: 'MEMBER-VC',
      v: 1,
      payload,
      payload_hash,
      nonce: rnd(12)
    };

    // é¡¯ç¤ºåœ¨ç•«é¢
    const vcTxt = JSON.stringify(vc, null, 2);
    document.getElementById('vcOut').value = vcTxt;

    // ä¸‹è¼‰ VC JSON
    const blob = new Blob([vcTxt], {type:'application/json;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'member_vc_' + role + '_' + Date.now() + '.json'

    a.click();
    URL.revokeObjectURL(a.href);

   // === å¯«ä¸€è¡Œå¯©è¨ˆæ—¥èªŒï¼ˆJSONLï¼‰ ===
const lines = readAuditLines();
const prev = lines.length ? await sha256Hex(JSON.stringify(lines[lines.length - 1])) : null;

const rec = {
  ts: nowISO(),
  actor: issuer || 'admin@rwa',
  action: 'VC_ISSUED',
  ref: 'member:' + subject,
  data_hash: await sha256Hex(vcTxt),
  prev_hash: prev,
  record_hash: null
};
rec.record_hash = await calcRecordHash(rec);

const sig = `${rec.action}|${rec.ref}|${rec.data_hash}`;
const seen = new Set(lines.map(x => `${x.action}|${x.ref}|${x.data_hash}`));
if (!seen.has(sig)) {
appendAudit(rec);
}
alert('å·²ç”¢ç”Ÿä¸¦ä¸‹è¼‰ VCï¼›åŒæ­¥å¯«å…¥ä¸€è¡Œéˆå¼å¯©è¨ˆæ—¥èªŒï¼ˆå¯ç”¨ã€ŒåŒ¯å‡ºã€ä¸‹è¼‰ audit_log.jsonlï¼‰');
});
  // ========= 5) åŒ¯å‡ºæ—¥èªŒ =========
  document.getElementById('btnExportLog').addEventListener('click', exportAudit);

function exportMemberReceipt(){
  const lines = readAuditLines();
  if (!lines.length){ alert('ç›®å‰é‚„æ²’æœ‰ä»»ä½•å¯©è¨ˆè¨˜éŒ„'); return; }
  // åªé‡å°æœ€æ–°ä¸€ç­†èˆ‡æˆå“¡æœ‰é—œçš„ç´€éŒ„ï¼ˆVC_ISSUED å„ªå…ˆï¼‰
  let rec = [...lines].reverse().find(x => x.action === 'VC_ISSUED') || lines[lines.length-1];


  const body = [
    'ã€æˆå“¡ VC ç°½ç« å›åŸ·ã€‘',
    `æ™‚é–“(ts):         ${rec.ts}`,
    `ç°½ç™¼è€…(actor):    ${rec.actor}`,
    `å‹•ä½œ(action):     ${rec.action}`,
    `æŒ‡æ¶‰(ref):        ${rec.ref}`,
    `è³‡æ–™é›œæ¹Š(data):   ${rec.data_hash}`,
    `å‰ä¸€æ‰‹(prev_hash):${rec.prev_hash ?? '(null)'}`,
    `æœ¬è²¼ç´™(record):   ${rec.record_hash}`,
    '',
    'èªªæ˜ï¼šè«‹æ­é… verify.html é©—éˆï¼ˆæ¯ä¸€å¼µè²¼ç´™è¦ç‰½ä½ä¸Šä¸€å¼µï¼‰ã€‚'
  ].join('\n');

  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([body], {type:'text/plain'}));
  const ts = new Date().toISOString().replace(/[-:.TZ]/g,'').slice(0,14);
const subj = String(rec.ref || '').replace(/^member:/,'').replace(/\W+/g,'-') || 'member';
a.download = `vc_receipt_${subj}_${ts}.txt`;


  a.click();
  URL.revokeObjectURL(a.href);
}
document.getElementById('btnReceipt').addEventListener('click', exportMemberReceipt);
 (function initWizard(){
      const start = document.getElementById('btnStartFlow');
      const hint = document.getElementById('flowHint');
      if (!start) return;

      start.addEventListener('click', () => {
        const v = (document.querySelector('input[name="flow"]:checked') || {}).value;
        if (v === 'A') {
          // ç•™åœ¨æœ¬é ï¼šæç¤ºæ¥ä¸‹ä¾†è¦åšä»€éº¼
          hint.textContent = 'è«‹å…ˆé¸è§’è‰²èˆ‡ä¸»é«”ï¼ŒæŒ‰ã€Œâ‘  ç”¢ç”Ÿ VCã€ï¼Œä¹‹å¾Œå¯åˆ° verify.html åšé©—éˆã€‚';
          hint.style.color = '#15803d';
        } else if (v === 'B') {
          // å°å‘ verifyï¼šå¸¶ä¸Šå°å°æç¤ºæ——æ¨™
          location.href = 'verify.html?guide=from_members';
        } else if (v === 'C') {
          // å°å‘ payout_verifyï¼šå¸¶ä¸Šå°å°æç¤ºæ——æ¨™
          location.href = 'payout_verify.html?guide=from_members';
        }
      });
    })();
  </script>
</body>
</html>