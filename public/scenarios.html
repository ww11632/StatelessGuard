<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>å¤šå ´æ™¯ Demoï½œStatelessGuard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Helvetica,Arial; margin:24px; line-height:1.6; background:#f9fafb; }
    .container { max-width:1200px; margin:0 auto; }
    .card { border:1px solid #e5e7eb; border-radius:12px; padding:20px; margin:16px 0; background:white; box-shadow:0 1px 3px rgba(0,0,0,0.1); }
    .card h3 { margin-top:0; color:#1f2937; }
    .scenario-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr)); gap:16px; margin:20px 0; }
    .scenario-card { border:1px solid #e8eaed; border-radius:12px; padding:16px; background:white; cursor:pointer; transition:all 0.2s; position:relative; }
    .scenario-card:hover { border-color:#3b82f6; box-shadow:0 4px 6px rgba(0,0,0,0.1); }
    .scenario-card.active { border-color:#3b82f6; background:#eff6ff; }
    .scenario-icon { font-size:32px; margin-bottom:14px; }
    .scenario-card .click-hint { opacity:0; transition:opacity 0.2s; font-size:12px; color:#9ca3af; margin-top:8px; }
    .scenario-card:hover .click-hint { opacity:1; }
    .scenario-steps { margin-top:12px; padding-left:20px; }
    .scenario-steps li { margin:4px 0; font-size:14px; color:#6b7280; }
    .demo-section { margin-top:20px; padding:16px; background:#f3f4f6; border-radius:8px; }
    .btn { padding:8px 16px; background:#3b82f6; color:white; border:none; border-radius:6px; cursor:pointer; margin:4px; }
    .btn:hover { background:#2563eb; }
    .btn.secondary { background:#6b7280; }
    .btn.secondary:hover { background:#4b5563; }
    .perf-stats { margin-top:16px; padding:12px; background:#f0fdf4; border-radius:8px; font-size:13px; }
    .perf-stats strong { color:#10b981; }
  </style>
</head>
<body>
  <div class="container">
    <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:24px;">
      <div>
        <h1 style="margin:0 0 8px 0; font-size:28px; color:#1f2937;">ğŸ¯ Scenarios ï½œ Multi-Domain Verification</h1>
        <p class="hint" style="color:#6b7280; margin:0; font-size:14px;">RWA / DAO / Social / AI Agent ç”Ÿæ…‹é©—è­‰å ´æ™¯</p>
      </div>
      <div id="statusIndicator" style="text-align:right; font-size:11px; color:#888; padding:12px 16px; background:#f9fafb; border-radius:8px; border:1px solid #e5e7eb; min-width:280px;">
        <div id="chainStatus" style="margin-bottom:6px;">
          <strong style="color:#1f2937;">Connected Chain:</strong> Celo-Sepolia <span style="color:#10b981;">âœ…</span>
        </div>
        <div id="chainDetails" style="font-size:10px; margin-bottom:6px; color:#6b7280; font-family:ui-monospace;">
          Block Height: <span id="blockHeight">8,594,544</span> | Latency: <span id="latency">1.2s</span>
        </div>
        <div id="capsuleStatus" style="font-family:ui-monospace; font-size:10px; border-top:1px solid #e5e7eb; padding-top:6px;">
          Last Verified: <span id="lastVerifiedTime">â€”</span><br>
          <span id="lastCapsule" style="color:#2563eb;">â€”</span>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="scenario-grid" id="scenarioGrid">
        <!-- é å…ˆå¯«å…¥å ´æ™¯å¡ç‰‡ï¼ˆç¢ºä¿å³ä½¿ JavaScript æœ‰å•é¡Œä¹Ÿèƒ½é¡¯ç¤ºï¼‰ -->
        <div class="scenario-card" data-key="rwa" style="cursor:pointer;">
          <div class="scenario-icon">ğŸ </div>
          <h4>RWA åˆè¦å…¥å£</h4>
          <p class="click-hint">é»æ“ŠæŸ¥çœ‹è©³æƒ…</p>
        </div>
        <div class="scenario-card" data-key="dao" style="cursor:pointer;">
          <div class="scenario-icon">ğŸ›ï¸</div>
          <h4>DAO æ²»ç†</h4>
          <p class="click-hint">é»æ“ŠæŸ¥çœ‹è©³æƒ…</p>
        </div>
        <div class="scenario-card" data-key="social" style="cursor:pointer;">
          <div class="scenario-icon">ğŸ‘¥</div>
          <h4>Social Network</h4>
          <p class="click-hint">é»æ“ŠæŸ¥çœ‹è©³æƒ…</p>
        </div>
        <div class="scenario-card" data-key="agent" style="cursor:pointer;">
          <div class="scenario-icon">ğŸ¤–</div>
          <h4>AI Agent Ecosystem</h4>
          <p class="click-hint">é»æ“ŠæŸ¥çœ‹è©³æƒ…</p>
        </div>
      </div>
    </div>

    <div id="selectedScenario" class="card" style="display:none;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
        <div>
          <h3 id="scenarioTitle" style="margin:0;"></h3>
          <p id="scenarioDesc" style="margin-top:8px;color:#6b7280;"></p>
        </div>
        <button class="btn secondary" onclick="document.getElementById('selectedScenario').style.display='none'">âœ• é—œé–‰</button>
      </div>
      
      <div id="scenarioSteps" style="margin-bottom:20px;"></div>
      
      <div class="demo-section">
        <h4>å¿«é€Ÿæ¸¬è©¦</h4>
        <div style="margin-bottom:12px;">
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
            <input type="checkbox" id="agentModeToggle" style="cursor:pointer;" />
            <span>ğŸ§  Proof-of-Agent DAO voterï¼ˆæ­¤æŠ•ç¥¨ç”± AI Agent ä»£è¡¨äººé¡åŸ·è¡Œï¼‰</span>
          </label>
        </div>
        <div style="margin-bottom:12px;">
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
            <span style="font-weight:600;color:#1f2937;">âš–ï¸ Policy:</span>
            <select id="policySelect" style="padding:4px 8px;border:1px solid #e5e7eb;border-radius:4px;font-size:13px;">
              <option value="agent-policy">AgentTrustPolicyV1</option>
              <option value="rwa-policy">RWACompliancePolicyV1</option>
              <option value="dao-policy">DAOGovernancePolicyV1</option>
            </select>
          </label>
        </div>
        <div style="margin-bottom:12px;">
          <button class="btn" onclick="window.testScenario && window.testScenario()">ğŸš€ æ¸¬è©¦æ­¤å ´æ™¯</button>
          <button class="btn secondary" id="btnTestRejected" style="display:none;" onclick="window.testRejected && window.testRejected()">âŒ æ¸¬è©¦æ‹’çµ•æ¡ˆä¾‹</button>
          <button class="btn secondary" id="btnTestDenylist" style="display:none;" onclick="window.testDenylist && window.testDenylist()">ğŸš« æ¸¬è©¦ Denylist å ´æ™¯</button>
        </div>
        <button class="btn secondary" onclick="window.viewPerformance && window.viewPerformance()">ğŸ“Š æŸ¥çœ‹æ€§èƒ½çµ±è¨ˆ</button>
        <button class="btn secondary" id="btnViewTrace" style="display:none;" onclick="window.viewCapsuleTrace && window.viewCapsuleTrace()">ğŸ” æª¢è¦– Capsule Trace</button>
        <button class="btn secondary" id="btnReplayAudit" onclick="window.replayAuditLog && window.replayAuditLog()">ğŸ”„ é‡æ’­é©—è­‰æµç¨‹</button>
        <button class="btn secondary" onclick="window.open('/self-onchain.html', '_blank')">ğŸ”— å‰å¾€é©—è­‰é é¢</button>
      </div>
      
      <div id="testResult" style="margin-top:16px;"></div>
    </div>

    <div id="perfStats" class="card" style="display:none;">
      <h3>ğŸ“Š æ€§èƒ½çµ±è¨ˆ</h3>
      <div id="perfContent" class="perf-stats">
        <p>è¼‰å…¥ä¸­...</p>
      </div>
    </div>

    <div id="statusSummary"></div>
    <div id="nav"></div>
  </div>

  <script src="js/nav.js?v=20251031v4v3"></script>
  <script src="js/statusSummary.js"></script>
  <script src="js/config.js"></script>
  <script>
    (function(){
      const SCENARIOS = {
        rwa: { icon: 'ğŸ ', name: 'RWA åˆè¦å…¥å£', color: '#10b981' },
        dao: { icon: 'ğŸ›ï¸', name: 'DAO æ²»ç†', color: '#3b82f6' },
        social: { icon: 'ğŸ‘¥', name: 'Social Network', color: '#8b5cf6' },
        agent: { icon: 'ğŸ¤–', name: 'AI Agent Ecosystem', color: '#f59e0b' },
      };
      
      let selectedScenario = null;
      
      // ç¢ºä¿ loadScenarios å‡½æ•¸åœ¨ DOM æº–å‚™å¥½å¾ŒåŸ·è¡Œ
      function init() {
        console.log('åˆå§‹åŒ–å‡½æ•¸è¢«èª¿ç”¨ï¼ŒDOM readyState:', document.readyState);
        if (document.readyState === 'loading') {
          console.log('ç­‰å¾… DOMContentLoaded äº‹ä»¶...');
          document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoaded äº‹ä»¶è§¸ç™¼');
            loadScenarios();
          });
        } else {
          console.log('DOM å·²æº–å‚™å¥½ï¼Œç«‹å³åŸ·è¡Œ loadScenarios');
          // ä½¿ç”¨ setTimeout ç¢ºä¿ DOM å®Œå…¨æº–å‚™å¥½
          setTimeout(loadScenarios, 100);
        }
      }

      // è¼‰å…¥å ´æ™¯åˆ—è¡¨ï¼ˆç¾åœ¨å ´æ™¯å¡ç‰‡å·²ç¶“é å…ˆå¯«åœ¨ HTML ä¸­ï¼‰
      function loadScenarios() {
        console.log('é–‹å§‹åˆå§‹åŒ–å ´æ™¯åˆ—è¡¨...');
        
        const grid = document.getElementById('scenarioGrid');
        if (!grid) {
          console.error('æ‰¾ä¸åˆ° scenarioGrid å…ƒç´ ');
          alert('éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°å ´æ™¯ç¶²æ ¼å…ƒç´ ï¼');
          return;
        }
        
        // ç¢ºä¿æ‰€æœ‰é å…ˆå¯«å…¥çš„å¡ç‰‡éƒ½æœ‰æ­£ç¢ºçš„é»æ“Šäº‹ä»¶
        const cards = grid.querySelectorAll('.scenario-card');
        console.log(`æ‰¾åˆ° ${cards.length} å€‹å ´æ™¯å¡ç‰‡`);
        
        if (cards.length === 0) {
          console.error('æ²’æœ‰æ‰¾åˆ°ä»»ä½•å ´æ™¯å¡ç‰‡ï¼');
          alert('éŒ¯èª¤ï¼šæ²’æœ‰æ‰¾åˆ°ä»»ä½•å ´æ™¯å¡ç‰‡ï¼');
          return;
        }
        
        cards.forEach((card, index) => {
          const key = card.getAttribute('data-key');
          if (!key) {
            console.warn(`å¡ç‰‡ ${index} æ²’æœ‰ data-key å±¬æ€§`);
            return;
          }
          
          console.log(`ç¶å®šå ´æ™¯å¡ç‰‡ï¼š${key}`);
          
          // ç›´æ¥ç¶å®šé»æ“Šäº‹ä»¶ï¼ˆä¸ä½¿ç”¨ cloneNodeï¼Œç›´æ¥ç¶å®šï¼‰
          card.style.cursor = 'pointer';
          card.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log(`âœ“ é»æ“Šå ´æ™¯å¡ç‰‡ï¼š${key}`, e);
            try {
              selectScenario(key, e);
            } catch(err) {
              console.error('selectScenario éŒ¯èª¤ï¼š', err);
              alert('é¸æ“‡å ´æ™¯æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š' + err.message);
            }
          }, false);
          
          console.log(`âœ“ å·²ç¶å®šå ´æ™¯å¡ç‰‡ï¼š${key}`);
        });
        
        // å¦‚æœ URL ä¸­æœ‰å ´æ™¯åƒæ•¸ï¼Œè‡ªå‹•é¸æ“‡
        const urlParams = new URLSearchParams(window.location.search);
        const autoScenario = urlParams.get('scenario');
        if (autoScenario && SCENARIOS[autoScenario]) {
          setTimeout(() => {
            try {
              selectScenario(autoScenario, null);
            } catch(err) {
              console.error('è‡ªå‹•é¸æ“‡å ´æ™¯éŒ¯èª¤ï¼š', err);
            }
          }, 100);
        }
        
        console.log('âœ“ å ´æ™¯åˆ—è¡¨åˆå§‹åŒ–å®Œæˆ');
      }

      // é¸æ“‡å ´æ™¯
      async function selectScenario(key, event) {
        console.log(`=== é¸æ“‡å ´æ™¯é–‹å§‹ï¼š${key} ===`, event);
        
        if (!key) {
          console.error('é¸æ“‡å ´æ™¯å¤±æ•—ï¼škey ç‚ºç©º');
          alert('éŒ¯èª¤ï¼šå ´æ™¯ key ç‚ºç©º');
          return;
        }
        
        if (!SCENARIOS[key]) {
          console.error(`é¸æ“‡å ´æ™¯å¤±æ•—ï¼šå ´æ™¯ ${key} ä¸å­˜åœ¨`);
          alert(`éŒ¯èª¤ï¼šå ´æ™¯ ${key} ä¸å­˜åœ¨`);
          return;
        }
        
        selectedScenario = key;
        console.log('selectedScenario å·²è¨­ç½®ç‚ºï¼š', selectedScenario);
        
        // ç§»é™¤æ‰€æœ‰ active ç‹€æ…‹
        document.querySelectorAll('.scenario-card').forEach(c => c.classList.remove('active'));
        
        // è¨­å®šç•¶å‰å¡ç‰‡ç‚º active
        let targetCard = null;
        if (event && event.currentTarget) {
          targetCard = event.currentTarget;
          console.log('ä½¿ç”¨ event.currentTargetï¼š', targetCard);
        } else if (event && event.target) {
          targetCard = event.target.closest('.scenario-card');
          console.log('ä½¿ç”¨ event.target.closestï¼š', targetCard);
        }
        
        if (targetCard) {
          targetCard.classList.add('active');
          console.log('âœ“ å·²è¨­å®šå¡ç‰‡ç‚º activeï¼ˆå¾ eventï¼‰ï¼š', targetCard);
        } else {
          // å¦‚æœç„¡æ³•å¾ event å–å¾—ï¼Œç›´æ¥æ‰¾åˆ°å°æ‡‰çš„å¡ç‰‡
          const cards = document.querySelectorAll('.scenario-card');
          console.log(`æ‰¾ä¸åˆ° event ä¸­çš„å¡ç‰‡ï¼Œæœç´¢ ${cards.length} å€‹å¡ç‰‡...`);
          cards.forEach(card => {
            if (card.getAttribute('data-key') === key) {
              card.classList.add('active');
              console.log('âœ“ å·²æ‰¾åˆ°ä¸¦è¨­å®šå¡ç‰‡ç‚º activeï¼š', card);
            }
          });
        }
        
        // ç«‹å³é¡¯ç¤ºå ´æ™¯å¡ç‰‡ï¼ˆä¸ç­‰å¾… APIï¼‰
        const scenario = SCENARIOS[key];
        const titleEl = document.getElementById('scenarioTitle');
        const descEl = document.getElementById('scenarioDesc');
        const stepsEl = document.getElementById('scenarioSteps');
        
        if (!titleEl || !descEl || !stepsEl) {
          console.error('æ‰¾ä¸åˆ°å¿…è¦çš„ DOM å…ƒç´ ', { titleEl, descEl, stepsEl });
          alert('éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°å ´æ™¯è©³æƒ…é¡¯ç¤ºå€åŸŸï¼');
          return;
        }
        
        titleEl.textContent = `${scenario.icon} ${scenario.name}`;
        descEl.textContent = 'é»æ“Šæ¸¬è©¦æŒ‰éˆ•å¯ç›´æ¥æ¸¬è©¦æ­¤å ´æ™¯';
        
        // ä½¿ç”¨é è¨­çš„æ­¥é©Ÿï¼ˆä¸ç­‰å¾… APIï¼‰
        const defaultSteps = {
          rwa: ['Self Proof é©—è­‰ï¼ˆèº«ä»½/åœ‹ç±/å¹´é½¡/OFACï¼‰', 'æ–‡ä»¶é›œæ¹Šé©—è­‰ï¼ˆç§Ÿç´„/æŠµæŠ¼å”è­°ï¼‰', 'æ’¥æ¬¾å‰æ ¸é©—', 'JSONL å¯©è¨ˆæ—¥èªŒ'],
          dao: ['èº«ä»½é©—è­‰ï¼ˆProof-of-Human / Proof-of-Agentï¼‰', 'ä¸€éµé©—è­‰èˆ‡æˆæ¬Š', 'æŠ•ç¥¨æ¬Šé™æˆäºˆ', 'ææ¡ˆç™¼èµ·æ¬Šé™'],
          social: ['èº«ä»½é©—è­‰ï¼ˆåœ‹ç±/å¹´é½¡ï¼‰', 'ç¤¾ç¾¤å‡†å…¥æª¢æŸ¥', 'å…§å®¹ç™¼å¸ƒæ¬Šé™', 'ä¿¡ä»»è©•åˆ†'],
          agent: ['Proof-of-Agent é©—è­‰', 'Sandbox åˆ†æ•¸æª¢æŸ¥', 'Agent ä¿¡ä»»éˆé©—è­‰', 'AI Agent ç™½åå–®'],
        };
        const defaultEndpoints = {
          rwa: ['/api/self/verify-by-tx', '/api/self/verify'],
          dao: ['/api/dao/verify', '/api/dao/auth'],
          social: ['/api/self/verify', '/api/social/verify'],
          agent: ['/api/agent/verify'],
        };
        
        const steps = defaultSteps[key] || [];
        const endpoints = defaultEndpoints[key] || [];
        
        console.log('è¨­ç½®å ´æ™¯æ­¥é©Ÿå’Œç«¯é»', { steps, endpoints });
        
        stepsEl.innerHTML = '<h4>æµç¨‹æ­¥é©Ÿï¼š</h4><ol class="scenario-steps">' +
          steps.map(s => `<li>${s}</li>`).join('') + '</ol>';
        
        if (endpoints.length > 0) {
          stepsEl.innerHTML += '<h4 style="margin-top:16px;">ç›¸é—œ API ç«¯é»ï¼š</h4><ul class="scenario-steps">' +
            endpoints.map(e => `<li><code style="font-size:12px;background:#f3f4f6;padding:2px 6px;border-radius:4px;">${e}</code></li>`).join('') + '</ul>';
        }
        
        const selectedDiv = document.getElementById('selectedScenario');
        const testResultDiv = document.getElementById('testResult');
        
        if (!selectedDiv) {
          console.error('æ‰¾ä¸åˆ° selectedScenario å…ƒç´ ');
          alert('éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°å ´æ™¯è©³æƒ…é¡¯ç¤ºå€åŸŸï¼');
          return;
        }
        
        selectedDiv.style.display = 'block';
        console.log('âœ“ å·²é¡¯ç¤ºå ´æ™¯è©³æƒ…å€åŸŸ');
        
        if (testResultDiv) {
          testResultDiv.innerHTML = ''; // æ¸…ç©ºæ¸¬è©¦çµæœ
        }
        
        // å˜—è©¦å¾ API è¼‰å…¥é¡å¤–è³‡è¨Šï¼ˆéé˜»å¡ï¼‰
        try {
          const apiBase = window.API_BASE_URL || '';
          const resp = await fetch(`${apiBase}/api/scenarios/${key}`);
          if (resp.ok) {
            const contentType = resp.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
            const data = await resp.json();
            if (data.name) document.getElementById('scenarioTitle').textContent = `${scenario.icon} ${data.name}`;
            if (data.description) document.getElementById('scenarioDesc').textContent = data.description;
            if (data.steps && Array.isArray(data.steps) && data.steps.length > 0) {
              stepsDiv.innerHTML = '<h4>æµç¨‹æ­¥é©Ÿï¼š</h4><ol class="scenario-steps">' +
                data.steps.map(s => `<li>${s}</li>`).join('') + '</ol>';
              if (data.endpoints && Array.isArray(data.endpoints)) {
                stepsDiv.innerHTML += '<h4 style="margin-top:16px;">ç›¸é—œ API ç«¯é»ï¼š</h4><ul class="scenario-steps">' +
                  data.endpoints.map(e => `<li><code style="font-size:12px;background:#f3f4f6;padding:2px 6px;border-radius:4px;">${e}</code></li>`).join('') + '</ul>';
              }
            }
          }
          }
        } catch(e) {
          console.log('API è¼‰å…¥å¤±æ•—ï¼ˆä½¿ç”¨é è¨­è³‡æ–™ï¼‰', e);
        }
      }
      
      // å¯©è¨ˆæ—¥èªŒæŸ¥çœ‹åŠŸèƒ½ï¼ˆåŒ…å« AI Agent Trace Capsuleï¼‰
      window.viewAuditLog = function() {
        const auditLog = window.__lastAuditLog;
        if (!auditLog) {
          alert('æ²’æœ‰å¯ç”¨çš„å¯©è¨ˆæ—¥èªŒè³‡æ–™');
          return;
        }
        
        // JSONL æ ¼å¼çš„å¯©è¨ˆæ¢ç›®
        const jsonlEntry = JSON.stringify(auditLog);
        
        // AI Agent Trace Capsuleï¼ˆå¯è¦–åŒ–å¯©è¨ˆéˆï¼‰
        let traceCapsuleHtml = '';
        if (auditLog.trace_capsule && Array.isArray(auditLog.trace_capsule)) {
          traceCapsuleHtml = `<div style="margin-top:16px;padding:12px;background:#f0f9ff;border-left:4px solid #3b82f6;border-radius:6px;">`;
          traceCapsuleHtml += `<strong style="color:#1e40af;font-size:14px;">ğŸ§© AI Agent Trace Capsule</strong><br>`;
          traceCapsuleHtml += `<div style="margin-top:8px;font-family:monospace;font-size:12px;line-height:1.8;">`;
          auditLog.trace_capsule.forEach((entry, index) => {
            const ts = new Date(entry.timestamp).toLocaleString('zh-TW', { 
              year: 'numeric', month: '2-digit', day: '2-digit',
              hour: '2-digit', minute: '2-digit', second: '2-digit'
            });
            traceCapsuleHtml += `${ts} | ${entry.action} | ${entry.details}<br>`;
          });
          traceCapsuleHtml += `</div>`;
          traceCapsuleHtml += `</div>`;
        }
        
        const auditLines = [
          `JSONL Audit Log Entry:`,
          ``,
          jsonlEntry,
          ``,
          `æ ¼å¼èªªæ˜ï¼š`,
          `- timestamp: å¯©è¨ˆæ™‚é–“`,
          `- action: æ“ä½œé¡å‹ï¼ˆAGENT_VERIFICATIONï¼‰`,
          `- status: ç‹€æ…‹ï¼ˆFAILï¼‰`,
          `- reason: å¤±æ•—åŸå› ï¼ˆAGENT_NOT_IN_WHITELISTï¼‰`,
          `- proof_ref: Proof å¼•ç”¨ï¼ˆèˆ‡è¿½æº¯éˆä¸€è‡´ï¼‰`,
          `- capsuleHash: Capsule é›œæ¹Šï¼ˆèˆ‡ RWA/DAO æ ¼å¼ä¸€è‡´ï¼‰`,
          `- sandbox_score: æ²™ç›’è©•ä¼°åˆ†æ•¸`,
          `- threshold: å®‰å…¨é–¾å€¼`,
          `- delegate_scope_denied: è¢«æ‹’çµ•çš„ä»£ç†ç¯„ç–‡`,
          `- trust_policy_version: ä¿¡ä»»æ”¿ç­–ç‰ˆæœ¬`,
          `- verifier: é©—è­‰è€…ï¼ˆStatelessGuardï¼‰`,
        ];
        
        // é¡¯ç¤ºå½ˆçª—
        const auditDiv = document.createElement('div');
        const auditModalId = 'auditEntryModal';
        auditDiv.id = auditModalId;
        auditDiv.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:24px;border-radius:12px;box-shadow:0 8px 16px rgba(0,0,0,0.2);max-width:800px;max-height:80vh;overflow:auto;z-index:1000;font-family:monospace;';
        auditDiv.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
            <h3 style="margin:0;color:#1f2937;">ğŸ—’ï¸ å¯©è¨ˆæ—¥èªŒ Entry</h3>
            <button onclick="document.getElementById('${auditModalId}')?.remove()" style="background:#ef4444;color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;">âœ• é—œé–‰</button>
          </div>
          ${traceCapsuleHtml}
          <div style="background:#f9fafb;padding:16px;border-radius:8px;font-size:13px;line-height:1.8;margin-top:16px;">
            <pre style="margin:0;white-space:pre-wrap;word-wrap:break-word;">${auditLines.join('\n')}</pre>
          </div>
          <div style="margin-top:16px;padding-top:16px;border-top:1px solid #e5e7eb;">
            <strong style="color:#6b7280;font-size:12px;">JSONL æ ¼å¼</strong>
            ${auditLog.jsonl_hash ? `
            <div style="margin-top:8px;padding:8px;background:#f0f9ff;border-left:3px solid #3b82f6;border-radius:4px;font-size:12px;">
              <strong style="color:#1e40af;">ğŸ§¾ JSONL Hash:</strong> <code style="font-size:11px;color:#6366f1;">${auditLog.jsonl_hash.slice(0, 8)}...${auditLog.jsonl_hash.slice(-8)}</code><br>
              <span style="color:#6b7280;font-size:11px;font-style:italic;">ï¼ˆæ¯æ¬¡é©—è­‰çš†å¯«å…¥éˆä¸Šå¯©è¨ˆç´€éŒ„ï¼‰</span>
            </div>
            ` : ''}
            <p style="color:#6b7280;font-size:12px;margin-top:8px;">æ­¤å¯©è¨ˆæ¢ç›®ç¬¦åˆ JSONL æ ¼å¼ï¼Œå¯è¿½åŠ åˆ°å¯©è¨ˆæ—¥èªŒæ–‡ä»¶ä¸­ã€‚æ¯å€‹é©—è­‰æ“ä½œéƒ½æœƒç”Ÿæˆé¡ä¼¼çš„å¯©è¨ˆæ¢ç›®ï¼Œå½¢æˆå®Œæ•´çš„å¯©è¨ˆéˆã€‚Trace Capsule å±•ç¤ºäº†å¾é©—è­‰åˆ°æˆæ¬Šæ±ºç­–çš„å®Œæ•´å¯©è¨ˆè·¯å¾‘ã€‚æ¯ä¸€æ¬¡é©—è­‰èˆ‡æ‹’çµ•éƒ½èƒ½è¢«éˆä¸Šè¿½æº¯ã€‚</p>
            <button onclick="navigator.clipboard.writeText('${jsonlEntry.replace(/'/g, "\\'")}').then(() => alert('å·²è¤‡è£½åˆ°å‰ªè²¼æ¿'))" style="margin-top:8px;background:#6366f1;color:white;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:12px;">ğŸ“‹ è¤‡è£½ JSONL</button>
          </div>
        `;
        document.body.appendChild(auditDiv);
      };
      
      // Capsule Trace æŸ¥çœ‹åŠŸèƒ½
      window.viewCapsuleTrace = function() {
        const data = window.__lastTestResult;
        if (!data || (!data.proof_ref && !data.capsuleHash && !data.trace)) {
          alert('æ²’æœ‰å¯ç”¨çš„ Capsule Trace è³‡æ–™');
          return;
        }
        
        const now = new Date();
        const traceLines = [];
        
        // æ§‹å»º JSONL æ ¼å¼çš„å¯©è¨ˆéˆ
        if (data.trace) {
          traceLines.push(`âœ… ${data.trace.proof_verified_at || now.toISOString()} â†’ Proof é©—è­‰`);
          traceLines.push(`âœ… ${data.trace.dao_auth_granted_at || now.toISOString()} â†’ DAO Auth Granted`);
          if (data.actions && Array.isArray(data.actions)) {
            traceLines.push(`âœ… ${now.toISOString()} â†’ ${data.actions.map(a => {
              const labels = {
                'vote': 'æŠ•ç¥¨æ¬Šé™å•Ÿç”¨',
                'propose': 'ææ¡ˆæ¬Šé™å•Ÿç”¨',
                'sign': 'ç°½ç½²æ¬Šé™å•Ÿç”¨',
                'whitelist': 'ç™½åå–®å•Ÿç”¨',
                'access': 'è¨ªå•æ¬Šé™å•Ÿç”¨',
              };
              return labels[a] || a;
            }).join(' / ')}`);
          }
        } else {
          traceLines.push(`âœ… ${data.timestamp || now.toISOString()} â†’ Proof é©—è­‰`);
          traceLines.push(`âœ… ${data.timestamp || now.toISOString()} â†’ DAO Auth Granted`);
        }
        
        traceLines.push('');
        traceLines.push('Chain of Trust:');
        traceLines.push(`- Proof Reference: ${data.proof_ref || 'N/A'}`);
        traceLines.push(`- Capsule Hash: ${data.capsuleHash || 'N/A'}`);
        if (data.verification?.agent_signature) {
          traceLines.push(`- Agent Signature: ${data.verification.agent_signature.slice(0, 20)}...${data.verification.agent_signature.slice(-10)}`);
        }
        traceLines.push(`- Verifier: StatelessGuard`);
        
        // å¢å¼·ç‰ˆï¼šå¾ audit_log.jsonl ç”Ÿæˆè¦–è¦ºåŒ–ä¿¡ä»»éˆ
        function loadAuditLog() {
          const raw = localStorage.getItem('audit_log_jsonl') || '';
          if (!raw.trim()) return [];
          try {
            return raw.split(/\r?\n/).filter(Boolean).map(line => {
              try { return JSON.parse(line); } catch { return null; }
            }).filter(Boolean);
          } catch {
            return [];
          }
        }

        const logs = loadAuditLog();
        const recentLogs = logs.slice(-5).reverse();
        const capsules = [];
        
        recentLogs.forEach((entry, index) => {
          const capsuleType = 
            entry.action?.includes('VERIFY') || entry.action?.includes('PROOF') ? 'Proof Capsule' :
            entry.action?.includes('VC') || entry.action?.includes('CREDENTIAL') ? 'VC Capsule' :
            entry.action?.includes('AUDIT') || entry.action?.includes('LOG') ? 'Audit Capsule' :
            entry.action?.includes('ONCHAIN') || entry.data_hash ? 'Onchain Capsule' :
            'Verification Capsule';
          
          capsules.push({
            step: recentLogs.length - index,
            capsule_id: `C-${String(recentLogs.length - index).padStart(3, '0')}`,
            prev_hash: entry.prev_hash || entry.prevHash || (index > 0 ? capsules[index - 1].capsule_hash : null),
            capsule_hash: entry.record_hash || entry.data_hash || entry.capsuleHash || 'N/A',
            module: capsuleType,
            action: entry.action || 'VERIFICATION',
            actor: entry.actor || 'StatelessGuard',
            timestamp: entry.ts || entry.timestamp || new Date().toISOString(),
            verified: true,
            raw_data: entry
          });
        });

        if (data && (data.capsuleHash || data.capsule_hash)) {
          const existingHash = data.capsuleHash || data.capsule_hash;
          const exists = capsules.some(c => c.capsule_hash === existingHash);
          if (!exists && capsules.length < 5) {
            capsules.unshift({
              step: capsules.length + 1,
              capsule_id: `C-${String(capsules.length + 1).padStart(3, '0')}`,
              prev_hash: capsules.length > 0 ? capsules[0].capsule_hash : null,
              capsule_hash: existingHash,
              module: data.context === 'agent-verification' ? 'Proof-of-Agent Capsule' : 'Verification Capsule',
              action: 'AGENT_VERIFICATION',
              actor: data.verifier || 'StatelessGuard',
              timestamp: data.timestamp || new Date().toISOString(),
              verified: data.status === 'verified',
              raw_data: data
            });
          }
        }

        // ç”Ÿæˆè¦–è¦ºåŒ– HTML
        let traceHtml = '<div style="margin-top:16px;">';
        traceHtml += '<div style="display:flex;flex-direction:column;gap:16px;position:relative;padding-left:24px;">';
        
        capsules.forEach((capsule, index) => {
          const isLast = index === capsules.length - 1;
          const ts = new Date(capsule.timestamp).toLocaleString('zh-TW', {
            month: '2-digit', day: '2-digit',
            hour: '2-digit', minute: '2-digit', second: '2-digit'
          });
          
          const shortHash = capsule.capsule_hash.length > 20 
            ? capsule.capsule_hash.slice(0, 10) + '...' + capsule.capsule_hash.slice(-8)
            : capsule.capsule_hash;
          
          traceHtml += `
            <div class="capsule-node" data-capsule-id="${capsule.capsule_id}" style="position:relative;">
              <div style="position:absolute;left:-24px;top:8px;width:2px;height:${isLast ? '8px' : 'calc(100% + 16px)'};background:#3b82f6;opacity:0.3;"></div>
              <div style="position:absolute;left:-28px;top:4px;width:12px;height:12px;border-radius:50%;background:#10b981;border:2px solid white;box-shadow:0 0 0 2px #10b981;"></div>
              <div style="background:white;border:2px solid #10b981;border-radius:8px;padding:12px;cursor:pointer;transition:all 0.2s;" 
                   onclick="window.showCapsuleDetail && window.showCapsuleDetail(${index})"
                   onmouseover="this.style.boxShadow='0 4px 12px rgba(16,185,129,0.2)';this.style.transform='translateX(4px)'"
                   onmouseout="this.style.boxShadow='none';this.style.transform='translateX(0)'">
                <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px;">
                  <div>
                    <div style="font-weight:600;color:#1f2937;font-size:14px;">${capsule.module}</div>
                    <div style="font-size:11px;color:#6b7280;margin-top:2px;">${capsule.action}</div>
                  </div>
                  <div style="background:#dcfce7;color:#166534;padding:4px 8px;border-radius:12px;font-size:11px;font-weight:600;">âœ…</div>
                </div>
                <div style="font-family:ui-monospace;font-size:11px;color:#2563eb;margin-top:8px;padding:6px;background:#f0f9ff;border-radius:4px;">
                  ${capsule.capsule_id}: ${shortHash}
                </div>
                <div style="font-size:11px;color:#9ca3af;margin-top:6px;">${ts} Â· ${capsule.actor}</div>
                ${capsule.prev_hash ? `<div style="font-size:10px;color:#9ca3af;margin-top:4px;font-style:italic;">prev: ${capsule.prev_hash.slice(0, 8)}...</div>` : ''}
              </div>
            </div>
          `;
        });
        
        traceHtml += '</div></div>';
        
        window.__capsules = capsules;
        
        // é¡¯ç¤º Modalï¼ˆå¦‚æœæœ‰ capsules å‰‡é¡¯ç¤ºè¦–è¦ºåŒ–ç‰ˆæœ¬ï¼Œå¦å‰‡é¡¯ç¤ºæ–‡æœ¬ç‰ˆæœ¬ï¼‰
        const traceDiv = document.createElement('div');
        traceDiv.id = 'capsuleTraceModal';
        traceDiv.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:24px;border-radius:12px;box-shadow:0 8px 16px rgba(0,0,0,0.2);max-width:800px;max-height:80vh;overflow:auto;z-index:1000;';
        
        if (capsules.length > 0) {
          traceDiv.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;border-bottom:2px solid #e5e7eb;padding-bottom:12px;">
              <div>
                <h3 style="margin:0;color:#1f2937;font-size:18px;">ğŸ§© Capsule Trace / Trust Path Layer</h3>
                <p style="margin:4px 0 0 0;color:#6b7280;font-size:12px;">ä¿¡ä»»é©—è­‰éˆæ¢çš„å¯è¿½è¹¤å°è£å–®ä½</p>
              </div>
              <button onclick="document.getElementById('capsuleTraceModal')?.remove()" style="background:#ef4444;color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:14px;">âœ• é—œé–‰</button>
            </div>
            ${traceHtml}
            <div style="margin-top:20px;padding-top:16px;border-top:1px solid #e5e7eb;">
              <p style="color:#6b7280;font-size:12px;line-height:1.6;">
                <strong>ä¿¡ä»»è·¯å¾‘å±¤èªªæ˜ï¼š</strong><br>
                Capsule Trace æ˜¯ StatelessGuard çš„ä¿¡ä»»è·¯å¾‘å±¤ï¼ˆTrust Path Layerï¼‰ã€‚å®ƒæŠŠ Proofã€VCã€Logã€Onchain é©—è­‰å°è£æˆå¯è¿½è¹¤çš„ capsuleï¼Œå½¢æˆä¸€æ¢å¯é©—å¯å¯©çš„è·¨åŸŸä¿¡ä»»éˆã€‚
                <span style="color:#2563eb;">é»æ“Šä¸Šæ–¹ç¯€é»å¯æŸ¥çœ‹å®Œæ•´çš„ JSON æ•¸æ“šã€‚</span>
              </p>
            </div>
          `;
        } else {
          traceDiv.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
              <h3 style="margin:0;color:#1f2937;">ğŸ” Capsule Trace / Audit Trail</h3>
              <button onclick="document.getElementById('capsuleTraceModal')?.remove()" style="background:#ef4444;color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;">âœ• é—œé–‰</button>
            </div>
            <div style="background:#f9fafb;padding:16px;border-radius:8px;font-size:13px;line-height:1.8;">
              <pre style="margin:0;white-space:pre-wrap;word-wrap:break-word;">${traceLines.join('\n')}</pre>
            </div>
            <div style="margin-top:16px;padding-top:16px;border-top:1px solid #e5e7eb;">
              <strong style="color:#6b7280;font-size:12px;">JSONL Audit Chain Summary</strong>
              <p style="color:#6b7280;font-size:12px;margin-top:8px;">æ­¤è¿½è¹¤éˆå±•ç¤ºäº†å¾åŸå§‹ Proof åˆ° DAO æˆæ¬Šçš„å®Œæ•´å¯©è¨ˆè·¯å¾‘ã€‚</p>
            </div>
          `;
        }
        
        document.body.appendChild(traceDiv);
      };
      
      // é¡¯ç¤ºå–®å€‹ Capsule çš„è©³ç´° JSON
      window.showCapsuleDetail = function(index) {
        if (!window.__capsules || !window.__capsules[index]) {
          alert('æ‰¾ä¸åˆ° Capsule è³‡æ–™');
          return;
        }
        
        const capsule = window.__capsules[index];
        const jsonStr = JSON.stringify(capsule.raw_data || capsule, null, 2);
        
        const detailDiv = document.createElement('div');
        const detailModalId = `capsuleDetailModal_${index}`;
        detailDiv.id = detailModalId;
        detailDiv.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:24px;border-radius:12px;box-shadow:0 8px 16px rgba(0,0,0,0.2);max-width:700px;max-height:80vh;overflow:auto;z-index:1001;';
        detailDiv.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
            <h3 style="margin:0;color:#1f2937;">${capsule.module} - ${capsule.capsule_id}</h3>
            <button onclick="document.getElementById('${detailModalId}')?.remove()" style="background:#ef4444;color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;">âœ• é—œé–‰</button>
          </div>
          <div style="background:#f9fafb;padding:16px;border-radius:8px;font-family:ui-monospace;font-size:12px;max-height:500px;overflow:auto;">
            <pre style="margin:0;white-space:pre-wrap;word-wrap:break-word;">${jsonStr}</pre>
          </div>
          <div style="margin-top:12px;">
            <button onclick="navigator.clipboard.writeText('${jsonStr.replace(/'/g, "\\'")}').then(() => alert('å·²è¤‡è£½ JSON åˆ°å‰ªè²¼æ¿'))" 
                    style="background:#6366f1;color:white;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:12px;">ğŸ“‹ è¤‡è£½ JSON</button>
          </div>
        `;
        document.body.appendChild(detailDiv);
      };
      
      // æ ¹æ“šå ´æ™¯é¡¯ç¤º/éš±è— Agent Mode Toggle
      const agentModeToggleContainer = document.querySelector('#agentModeToggle')?.closest('div');
      if (agentModeToggleContainer) {
        agentModeToggleContainer.style.display = 'none'; // é»˜èªéš±è—
      }
      
      // æ¸¬è©¦æ‹’çµ•æ¡ˆä¾‹å‡½æ•¸
      window.testRejected = async function() {
        const selectedScenario = window.__lastScenario || 'agent';
        const resultDiv = document.getElementById('testResult');
        resultDiv.innerHTML = '<p style="color:#6b7280;">â³ æ¸¬è©¦æ‹’çµ•æ¡ˆä¾‹ä¸­...</p>';
        
        try {
          let testUrl = '/api/agent/verify';
          let testBody = { 
            agentAddress: 'DEMO_FAIL_AGENT_NOT_TRUSTED',
            policy: 'agent-policy' // ä½¿ç”¨ agent-policy
          };
          
          const apiBase = window.API_BASE_URL || '';
          const fullUrl = apiBase + testUrl;
          
          const resp = await fetch(fullUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(testBody),
          });
          
          if (!resp.ok) {
            throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
          }
          
          const data = await resp.json();
          
          // é¡¯ç¤ºæ‹’çµ•çµæœï¼ˆå¢å¼·ç‰ˆï¼‰
          let resultHtml = `
            <div style="padding:12px;background:#fee2e2;border-radius:8px;border-left:4px solid #ef4444;">
              <strong>âŒ æ‹’çµ•æ¡ˆä¾‹æ¸¬è©¦</strong><br>
              <p style="color:#dc2626;margin-top:8px;"><strong>ç‹€æ…‹ï¼š</strong>${data.status}</p>
              <p style="color:#dc2626;margin-top:8px;"><strong>åŸå› ï¼š</strong>${data.reason || 'N/A'}</p>
          `;
          
          // é¡¯ç¤º proof_ref å’Œ capsuleHashï¼ˆè¿½æº¯éˆä¸€è‡´ï¼‰
          if (data.proof_ref || data.capsuleHash) {
            resultHtml += `<div style="margin-top:12px;padding:8px;background:#eff6ff;border-radius:6px;font-size:12px;">`;
            resultHtml += `<strong>ğŸ”— è¿½æº¯éˆï¼š</strong><br>`;
            if (data.proof_ref) {
              resultHtml += `proof_ref: <code style="font-size:11px;">${data.proof_ref.length > 50 ? data.proof_ref.slice(0, 30) + '...' + data.proof_ref.slice(-10) : data.proof_ref}</code><br>`;
            }
            if (data.capsuleHash) {
              resultHtml += `capsuleHash: <code style="font-size:11px;">${data.capsuleHash.length > 50 ? data.capsuleHash.slice(0, 30) + '...' + data.capsuleHash.slice(-10) : data.capsuleHash}</code>`;
            }
            resultHtml += `</div>`;
          }
          
          // é¡¯ç¤º sandbox_score å’Œ thresholdï¼ˆAI safety framingï¼Œè¦–è¦ºåŒ–é€²åº¦æ¢ï¼‰
          if (data.sandbox_score !== undefined || data.threshold !== undefined) {
            const score = data.sandbox_score !== undefined ? data.sandbox_score : 0;
            const threshold = data.threshold !== undefined ? data.threshold : 0.9;
            const percentage = Math.min((score / threshold) * 100, 100);
            const scoreColor = score < threshold ? '#dc2626' : '#10b981';
            const filledBlocks = Math.floor(percentage / 5); // æ¯5%ä¸€å€‹æ–¹å¡Šï¼Œå…±20å€‹
            const emptyBlocks = 20 - filledBlocks;
            
            resultHtml += `<div style="margin-top:12px;padding:12px;background:#fef3c7;border-radius:6px;font-size:12px;">`;
            resultHtml += `<strong>ğŸ§  å®‰å…¨è©•ä¼°ï¼š</strong><br>`;
            resultHtml += `<div style="margin-top:8px;">`;
            resultHtml += `<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">`;
            resultHtml += `<span style="font-weight:bold;color:${scoreColor};">Sandbox Score: ${score.toFixed(2)} / ${threshold}</span>`;
            resultHtml += `</div>`;
            resultHtml += `<div style="display:flex;align-items:center;gap:2px;font-family:monospace;font-size:14px;">`;
            resultHtml += `<span style="color:${scoreColor};">${'â–ˆ'.repeat(filledBlocks)}</span>`;
            resultHtml += `<span style="color:#d1d5db;">${'â–‘'.repeat(emptyBlocks)}</span>`;
            resultHtml += `</div>`;
            resultHtml += `<p style="margin-top:4px;color:#92400e;font-size:11px;">${score < threshold ? 'ï¼ˆå®‰å…¨é–¾å€¼æœªé”ï¼‰' : 'ï¼ˆå·²é”å®‰å…¨é–¾å€¼ï¼‰'}</p>`;
            resultHtml += `</div>`;
            
            if (data.evaluation_result) {
              resultHtml += `<p style="margin-top:8px;color:#92400e;font-size:11px;">${data.evaluation_result}</p>`;
            }
            
            // é¡¯ç¤ºä¿¡ä»»æ”¿ç­–ç‰ˆæœ¬
            if (data.trust_policy_version) {
              resultHtml += `<p style="margin-top:8px;color:#6b7280;font-size:10px;">ä¿¡ä»»æ”¿ç­–ç‰ˆæœ¬: <code>${data.trust_policy_version}</code></p>`;
            }
            
            resultHtml += `</div>`;
          }
          
          // é¡¯ç¤º delegation_scopeï¼ˆæ¬Šé™çµæ§‹é–‰ç’°ï¼‰
          if (data.delegation_scope && Array.isArray(data.delegation_scope)) {
            resultHtml += `<div style="margin-top:12px;padding:8px;background:#f3f4f6;border-radius:6px;font-size:12px;">`;
            resultHtml += `<strong>ğŸš« æœªæˆæ¬Šç¯„ç–‡ï¼š</strong><br>`;
            resultHtml += `delegation_scope: ${data.delegation_scope.map(s => `<code>${s}</code>`).join(', ')}<br>`;
            if (data.delegation_note) {
              resultHtml += `<p style="margin-top:4px;color:#6b7280;font-size:11px;">${data.delegation_note}</p>`;
            }
            resultHtml += `</div>`;
          }
          
          // é¡¯ç¤º Trace Capsuleï¼ˆå¯è¦–åŒ–å¯©è¨ˆéˆï¼‰
          if (data.trace_capsule && Array.isArray(data.trace_capsule)) {
            resultHtml += `<div style="margin-top:12px;padding:12px;background:#f0f9ff;border-left:4px solid #3b82f6;border-radius:6px;font-size:12px;">`;
            resultHtml += `<strong style="color:#1e40af;font-size:14px;">ğŸ§© Capsule Trace</strong><br>`;
            resultHtml += `<div style="margin-top:8px;font-family:monospace;font-size:12px;line-height:1.8;color:#1e293b;">`;
            data.trace_capsule.forEach((entry) => {
              const ts = new Date(entry.timestamp).toLocaleString('zh-TW', { 
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit', second: '2-digit'
              });
              resultHtml += `${ts} | ${entry.action} | ${entry.details}<br>`;
            });
            resultHtml += `</div>`;
            resultHtml += `<p style="margin-top:8px;color:#6b7280;font-size:11px;font-style:italic;">ä¿¡ä»»æ˜¯è¢«ä¸€æ­¥æ­¥æ¨å°å‡ºä¾†çš„ï¼Œä¸åªæ˜¯è¢«åˆ¤å®šã€‚</p>`;
            resultHtml += `</div>`;
          }
          
          // é¡¯ç¤ºå¯©è¨ˆ log æŒ‰éˆ•
          if (data.audit_log) {
            resultHtml += `<div style="margin-top:12px;padding:8px;background:#f9fafb;border-radius:6px;font-size:12px;">`;
            resultHtml += `<button id="btnViewAuditLog" onclick="window.viewAuditLog && window.viewAuditLog()" style="background:#6366f1;color:white;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:12px;">ğŸ—’ï¸ å¯©è¨ˆæ—¥èªŒ</button>`;
            resultHtml += `</div>`;
            // å­˜å„²å¯©è¨ˆ log ä»¥ä¾¿æŸ¥çœ‹
            window.__lastAuditLog = data.audit_log;
          }
          
          if (data.human_readable) {
            resultHtml += `<div style="margin-top:12px;padding:12px;background:#fef2f2;border-radius:6px;font-size:13px;">`;
            resultHtml += `<strong>ğŸ’¬ æè¿°ï¼š</strong><br>`;
            resultHtml += `<p style="margin-top:4px;color:#991b1b;">${data.human_readable}</p>`;
            resultHtml += `</div>`;
          }
          
          if (data.network || data.source) {
            resultHtml += `<div style="margin-top:12px;padding:8px;background:#f3f4f6;border-radius:6px;font-size:12px;">`;
            resultHtml += `<strong>ğŸŒ ç¶²è·¯è³‡è¨Šï¼š</strong><br>`;
            if (data.network) {
              resultHtml += `network: <code>${data.network}</code><br>`;
            }
            if (data.source) {
              resultHtml += `source: <code>${data.source}</code>`;
            }
            resultHtml += `</div>`;
          }
          
          resultHtml += `
              <details style="margin-top:8px;">
                <summary style="cursor:pointer;color:#3b82f6;">æŸ¥çœ‹å®Œæ•´å›æ‡‰</summary>
                <pre style="font-size:12px;overflow:auto;max-height:200px;margin-top:8px;padding:8px;background:#f9fafb;border-radius:4px;">${JSON.stringify(data, null, 2)}</pre>
              </details>
            </div>
          `;
          
          resultDiv.innerHTML = resultHtml;
          
          // å­˜å„²çµæœä»¥ä¾¿å¾ŒçºŒæŸ¥çœ‹
          window.__lastTestResult = data;
          window.__lastScenario = selectedScenario;
        } catch(e) {
          console.error('æ‹’çµ•æ¡ˆä¾‹æ¸¬è©¦å¤±æ•—ï¼š', e);
          resultDiv.innerHTML = `<div style="padding:12px;background:#fee2e2;border-radius:8px;color:#b91c1c;">
            <strong>âŒ æ¸¬è©¦å¤±æ•—</strong><br>
            <p style="margin-top:4px;font-size:13px;">${String(e)}</p>
          </div>`;
        }
      };
      
      // é¸æ“‡å ´æ™¯æ™‚ï¼Œå¦‚æœæ˜¯ DAO å ´æ™¯å‰‡é¡¯ç¤º toggleï¼Œå¦‚æœæ˜¯ agent å ´æ™¯å‰‡é¡¯ç¤ºæ‹’çµ•æ¡ˆä¾‹æŒ‰éˆ•
      const originalSelectScenario = selectScenario;
      selectScenario = function(key, event) {
        originalSelectScenario(key, event);
        if (agentModeToggleContainer) {
          agentModeToggleContainer.style.display = key === 'dao' ? 'block' : 'none';
        }
        // é¡¯ç¤º/éš±è—æ‹’çµ•æ¡ˆä¾‹æŒ‰éˆ•ï¼ˆåƒ…åœ¨ agent å ´æ™¯ï¼‰
        const btnTestRejected = document.getElementById('btnTestRejected');
        if (btnTestRejected) {
          btnTestRejected.style.display = key === 'agent' ? 'inline-block' : 'none';
        }
        // é¡¯ç¤º/éš±è— Denylist å ´æ™¯æŒ‰éˆ•ï¼ˆåœ¨æ‰€æœ‰å ´æ™¯éƒ½å¯é¡¯ç¤ºï¼‰
        const btnTestDenylist = document.getElementById('btnTestDenylist');
        if (btnTestDenylist) {
          btnTestDenylist.style.display = 'inline-block';
        }
        // éš±è— Trace æŒ‰éˆ•ç›´åˆ°æœ‰æ¸¬è©¦çµæœ
        const btnViewTrace = document.getElementById('btnViewTrace');
        if (btnViewTrace) {
          btnViewTrace.style.display = 'none';
        }
      };
      
      // å°‡å‡½æ•¸æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸï¼ˆè®“ onclick å¯ä»¥è¨ªå•ï¼‰
      window.selectScenario = selectScenario;
      window.SCENARIOS = SCENARIOS;
      
      // æ¸¬è©¦ï¼šç›´æ¥åœ¨ window ä¸Šæ·»åŠ ä¸€å€‹æ¸¬è©¦å‡½æ•¸
      window.testClick = function(key) {
        console.log('æ¸¬è©¦é»æ“Šï¼š', key);
        alert('æ¸¬è©¦é»æ“Šï¼š' + key);
        selectScenario(key, null);
      };

      // æ¸¬è©¦å ´æ™¯
      async function testScenario() {
        if (!selectedScenario) {
          alert('è«‹å…ˆé¸æ“‡ä¸€å€‹å ´æ™¯');
          return;
        }
        
        const resultDiv = document.getElementById('testResult');
        resultDiv.innerHTML = '<p style="color:#6b7280;">â³ æ¸¬è©¦ä¸­...</p>';
        
        try {
          let testUrl = '';
          let testBody = {};
          
          switch(selectedScenario) {
            case 'rwa':
              // RWA æµç¨‹ï¼šå…ˆé©—è­‰èº«ä»½ï¼Œå†é©—è­‰æ–‡ä»¶é›œæ¹Š
              // ç‚ºäº†å®Œæ•´å±•ç¤ºæµç¨‹ï¼Œæˆ‘å€‘æœƒä¾åºèª¿ç”¨å…©å€‹ API
              testUrl = '/api/self/verify-by-tx';
              testBody = { txHash: 'DEMO_SUCCESS_TW' };
              
              // å…ˆé©—è­‰èº«ä»½ï¼ˆåœ¨ switch å¤–è™•ç†ï¼‰
              break;
            case 'social':
              testUrl = '/api/social/verify';
              testBody = { txHash: 'DEMO_SUCCESS_TW' };
              break;
            case 'dao':
              // DAO æµç¨‹ï¼šå…ˆæˆæ¬Šï¼Œå†é©—è­‰ææ¡ˆï¼ˆåŒ…å«æ–‡ä»¶é›œæ¹Šå¯©è¨ˆï¼‰
              testUrl = '/api/dao/auth';
              // æª¢æŸ¥æ˜¯å¦å•Ÿç”¨ Proof-of-Agent æ¨¡å¼
              const agentModeToggle = document.getElementById('agentModeToggle');
              const isAgentMode = agentModeToggle && agentModeToggle.checked;
              
              if (isAgentMode) {
                // Proof-of-Agent DAO voter æ¨¡å¼
                testBody = { 
                  agentAddress: '0x1234567890abcdef1234567890abcdef12345678',
                  actions: ['vote', 'propose'] // æ”¯æŒå¤šç¨®è¡Œç‚º
                };
              } else {
                // Proof-of-Human DAO voter æ¨¡å¼
                testBody = { 
                  txHash: 'DEMO_SUCCESS_TW', 
                  actions: ['vote', 'propose'] // ä½¿ç”¨æ–°çš„ actions æ•¸çµ„è¨­è¨ˆ
                };
              }
              
              // å…ˆæˆæ¬Šï¼Œç„¶å¾Œé©—è­‰ææ¡ˆï¼ˆåŒ…å«æ–‡ä»¶é›œæ¹Šï¼‰
              // é€™æœƒåœ¨ switch å¤–è™•ç†
              break;
            case 'agent':
              testUrl = '/api/agent/verify';
              // å¾ Policy é¸æ“‡å™¨ç²å– policy
              const policySelect = document.getElementById('policySelect');
              const selectedPolicy = policySelect ? policySelect.value : 'agent-policy';
              testBody = { 
                agentAddress: '0x1234567890abcdef1234567890abcdef12345678',
                policy: selectedPolicy // ä½¿ç”¨é¸æ“‡çš„ policy
              };
              break;
            default:
              testUrl = '/api/self/verify-by-tx';
              testBody = { txHash: 'DEMO_SUCCESS_TW' };
          }
          
          const startTime = Date.now();
          
          // æª¢æŸ¥ Firebase Functions æ˜¯å¦é‹è¡Œï¼ˆé€šéæª¢æŸ¥ config.js æˆ–ä½¿ç”¨ç›¸å°è·¯å¾‘ï¼‰
          // å¦‚æœ Firebase Functions åœ¨ localhost:5001ï¼Œéœ€è¦è™•ç† CORS æˆ–ä½¿ç”¨ä»£ç†
          const apiBase = window.API_BASE_URL || '';
          
          // RWA å ´æ™¯çš„ç‰¹æ®Šè™•ç†ï¼šå…ˆé©—è­‰èº«ä»½ï¼Œå†é©—è­‰æ–‡ä»¶é›œæ¹Š
          if (selectedScenario === 'rwa' && testUrl === '/api/self/verify-by-tx') {
            try {
              // å…ˆé©—è­‰èº«ä»½
              const verifyResp = await fetch(apiBase + testUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(testBody),
              });
              
              if (verifyResp.ok) {
                const verifyData = await verifyResp.json();
                
                // ç„¶å¾Œé©—è­‰æ–‡ä»¶é›œæ¹Šï¼ˆä½¿ç”¨ proof_ref ä½œç‚ºé—œè¯ï¼‰
                const docHash = '0x' + Array.from({length: 64}, () => Math.floor(Math.random() * 16).toString(16)).join('');
                testUrl = '/api/doc/hash-verify';
                testBody = { 
                  docHash: docHash,
                  docType: 'lease_agreement',
                  proof_ref: verifyData.proof_ref || verifyData.capsuleHash || null,
                };
              } else {
                // å¦‚æœèº«ä»½é©—è­‰å¤±æ•—ï¼Œç›´æ¥æ¸¬è©¦æ–‡ä»¶é›œæ¹Šé©—è­‰
                const docHash = '0x' + Array.from({length: 64}, () => Math.floor(Math.random() * 16).toString(16)).join('');
                testUrl = '/api/doc/hash-verify';
                testBody = { 
                  docHash: docHash,
                  docType: 'lease_agreement',
                };
              }
            } catch (e) {
              console.log('RWA æµç¨‹ï¼šè·³éèº«ä»½é©—è­‰ï¼Œç›´æ¥æ¸¬è©¦æ–‡ä»¶é›œæ¹Šé©—è­‰', e);
              // å¦‚æœèº«ä»½é©—è­‰å¤±æ•—ï¼Œç›´æ¥æ¸¬è©¦æ–‡ä»¶é›œæ¹Šé©—è­‰
              const docHash = '0x' + Array.from({length: 64}, () => Math.floor(Math.random() * 16).toString(16)).join('');
              testUrl = '/api/doc/hash-verify';
              testBody = { 
                docHash: docHash,
                docType: 'lease_agreement',
              };
            }
          }
          
          // DAO å ´æ™¯çš„ç‰¹æ®Šè™•ç†ï¼šå…ˆæˆæ¬Šï¼Œå†é©—è­‰ææ¡ˆï¼ˆåŒ…å«æ–‡ä»¶é›œæ¹Šå¯©è¨ˆï¼‰
          if (selectedScenario === 'dao' && testUrl === '/api/dao/auth') {
            try {
              // å…ˆæˆæ¬Š
              const authResp = await fetch(apiBase + testUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(testBody),
              });
              
              if (authResp.ok) {
                const authData = await authResp.json();
                
                // ç„¶å¾Œé©—è­‰ææ¡ˆï¼ˆåŒ…å«æ–‡ä»¶é›œæ¹Šå¯©è¨ˆï¼Œå±•ç¤º DAO â†’ RWA â†’ Audit éˆè·¯ï¼‰
                const docHash = '0x' + Array.from({length: 64}, () => Math.floor(Math.random() * 16).toString(16)).join('');
                testUrl = '/api/dao/proposal-verify';
                testBody = { 
                  proposalId: `PROP-${Date.now()}`,
                  docHash: docHash,
                  proof_ref: authData.proof_ref || authData.capsuleHash || null,
                  agentAddress: testBody.agentAddress || null,
                  txHash: testBody.txHash || null,
                };
              } else {
                // å¦‚æœæˆæ¬Šå¤±æ•—ï¼Œç›´æ¥æ¸¬è©¦ææ¡ˆé©—è­‰
                const docHash = '0x' + Array.from({length: 64}, () => Math.floor(Math.random() * 16).toString(16)).join('');
                testUrl = '/api/dao/proposal-verify';
                testBody = { 
                  proposalId: `PROP-${Date.now()}`,
                  docHash: docHash,
                };
              }
            } catch (e) {
              console.log('DAO æµç¨‹ï¼šè·³éæˆæ¬Šï¼Œç›´æ¥æ¸¬è©¦ææ¡ˆé©—è­‰', e);
              // å¦‚æœæˆæ¬Šå¤±æ•—ï¼Œç›´æ¥æ¸¬è©¦ææ¡ˆé©—è­‰
              const docHash = '0x' + Array.from({length: 64}, () => Math.floor(Math.random() * 16).toString(16)).join('');
              testUrl = '/api/dao/proposal-verify';
              testBody = { 
                proposalId: `PROP-${Date.now()}`,
                docHash: docHash,
              };
            }
          }
          
          let fullUrl = apiBase + testUrl;
          
          // å¦‚æœ API_BASE_URL æœªè¨­ç½®ï¼Œå˜—è©¦ä½¿ç”¨ç›¸å°è·¯å¾‘ï¼ˆFirebase Hosting æœƒä»£ç†åˆ° Functionsï¼‰
          // å¦‚æœæ˜¯åœ¨æœ¬åœ°é–‹ç™¼ï¼Œå¯èƒ½éœ€è¦ä½¿ç”¨ http://localhost:5001 æˆ–é€šé Firebase Hosting ä»£ç†
          
          const resp = await fetch(fullUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(testBody),
          });
          
          if (!resp.ok) {
            // å˜—è©¦è§£æéŒ¯èª¤è¨Šæ¯
            let errorMsg = `HTTP ${resp.status}: ${resp.statusText}`;
            try {
              const errorData = await resp.text();
              if (errorData) {
                try {
                  const errorJson = JSON.parse(errorData);
                  errorMsg = errorJson.error || errorJson.message || errorMsg;
                } catch {
                  // å¦‚æœä¸æ˜¯ JSONï¼Œä½¿ç”¨åŸå§‹æ–‡å­—
                  if (errorData.length < 200) {
                    errorMsg = errorData;
                  }
                }
              }
            } catch {}
            throw new Error(errorMsg);
          }
          
          // æª¢æŸ¥å›æ‡‰æ˜¯å¦ç‚º JSON
          const contentType = resp.headers.get('content-type');
          if (!contentType || !contentType.includes('application/json')) {
            const text = await resp.text();
            throw new Error(`API è¿”å›é JSON æ ¼å¼ï¼ˆ${contentType}ï¼‰ã€‚è«‹ç¢ºèª Firebase Functions æ­£åœ¨é‹è¡Œã€‚`);
          }
          
          const elapsed = Date.now() - startTime;
          const data = await resp.json();
          
          // ä¿å­˜ capsuleHash åˆ° localStorageï¼ˆä¾› statusSummary.js è®€å–ï¼‰
          if (data.capsuleHash || data.capsule_hash) {
            const capsuleHash = data.capsuleHash || data.capsule_hash;
            localStorage.setItem('last_capsule_hash', capsuleHash);
            
            // è¿½åŠ åˆ° audit logï¼ˆæœ¬åœ°å’Œå¾Œç«¯ï¼‰
            try {
              // ç²å–ä¸Šä¸€ç­†è¨˜éŒ„çš„ record_hashï¼ˆå»ºç«‹éˆå¼é—œä¿‚ï¼‰
              const existingLog = localStorage.getItem('audit_log_jsonl') || '';
              let prevHash = null;
              if (existingLog) {
                try {
                  const lines = existingLog.trim().split('\n').filter(line => line.trim());
                  if (lines.length > 0) {
                    const lastLine = JSON.parse(lines[lines.length - 1]);
                    prevHash = lastLine.record_hash || null;
                  }
                } catch (e) {
                  console.warn('è§£æä¸Šä¸€ç­†è¨˜éŒ„å¤±æ•—:', e);
                }
              }
              
              // è¨ˆç®— record_hashï¼ˆéœ€è¦åœ¨è¨ˆç®—å‰æ§‹å»ºï¼Œä¸åŒ…å« record_hashï¼‰
              // æ³¨æ„ï¼šå¿…é ˆèˆ‡å¾Œç«¯ calculateRecordHash çš„ excludedFields å®Œå…¨ä¸€è‡´
              async function calculateRecordHash(data) {
                // æ’é™¤ record_hash æœ¬èº«ï¼Œä»¥åŠå¾Œç«¯æ·»åŠ çš„æ¬„ä½
                const excludedFields = [
                  'record_hash',
                  'audit_id',
                  'ipfs_cid',
                  'ipfs_url',
                  'audit_saved',
                  'audit_error',
                  'created_at',
                  'source',   // å¾Œç«¯æ·»åŠ çš„å…ƒæ•¸æ“š
                  'version'  // å¾Œç«¯æ·»åŠ çš„å…ƒæ•¸æ“š
                ];
                
                const hashData = {};
                Object.keys(data).forEach(key => {
                  if (!excludedFields.includes(key)) {
                    hashData[key] = data[key];
                  }
                });
                
                // ç©©å®šæ’åºçš„ JSON å­—ç¬¦ä¸²
                const sortedKeys = Object.keys(hashData).sort();
                const jsonObj = {};
                sortedKeys.forEach(key => jsonObj[key] = hashData[key]);
                const jsonString = JSON.stringify(jsonObj);
                // ä½¿ç”¨ Web Crypto API è¨ˆç®— SHA-256
                const encoder = new TextEncoder();
                const dataBuf = encoder.encode(jsonString);
                const hashBuf = await crypto.subtle.digest('SHA-256', dataBuf);
                const hashArray = Array.from(new Uint8Array(hashBuf));
                const hashHex = '0x' + hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                return hashHex;
              }
              
              // æ§‹å»º audit log è¨˜éŒ„ï¼ˆå…ˆä¸åŒ…å« record_hashï¼‰
              const auditEntryBase = {
                timestamp: new Date().toISOString(),
                action: data.context || 'VERIFICATION',
                status: data.status || 'verified',
                capsuleHash: capsuleHash,
                scenario: selectedScenario,
                policy: data.policy_id || document.getElementById('policySelect')?.value || 'agent-policy',
                prev_hash: prevHash, // ä¸Šä¸€ç­†çš„ record_hash
                ...Object.fromEntries(
                  Object.entries(data).filter(([key]) => key !== 'record_hash')
                )
              };
              
              // è¨ˆç®—ä¸¦æ·»åŠ  record_hash
              const recordHash = await calculateRecordHash(auditEntryBase);
              const auditEntry = {
                ...auditEntryBase,
                record_hash: recordHash
              };
              
              // 1. ä¿å­˜åˆ° localStorageï¼ˆæœ¬åœ°å‚™ä»½ï¼‰
              const newLine = JSON.stringify(auditEntry);
              localStorage.setItem('audit_log_jsonl', existingLog + (existingLog ? '\n' : '') + newLine);
              
              // 2. ç™¼é€åˆ°å¾Œç«¯ Firestoreï¼ˆæŒä¹…åŒ–ï¼‰
              try {
                const apiBase = window.API_BASE_URL || '';
                console.log('ğŸ“¤ ç™¼é€ audit log åˆ°å¾Œç«¯:', apiBase + '/api/audit');
                const auditResp = await fetch(apiBase + '/api/audit', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(auditEntry),
                });
                
                console.log('ğŸ“¥ Audit log éŸ¿æ‡‰ç‹€æ…‹:', auditResp.status, auditResp.statusText);
                
                if (auditResp.ok) {
                  const auditResult = await auditResp.json();
                  console.log('âœ… Audit log éŸ¿æ‡‰:', auditResult);
                  // ä¿å­˜ audit_id å’Œ IPFS CID åˆ° auditEntryï¼ˆç”¨æ–¼é¡¯ç¤ºï¼‰
                  auditEntry.audit_id = auditResult.audit_id;
                  auditEntry.audit_saved = true;
                  
                  // å¦‚æœå¾Œç«¯è¿”å› IPFS CIDï¼Œä¿å­˜å®ƒ
                  if (auditResult.ipfs_cid) {
                    auditEntry.ipfs_cid = auditResult.ipfs_cid;
                    auditEntry.ipfs_url = auditResult.ipfs_url;
                    window.__lastIpfsCid = auditResult.ipfs_cid;
                    window.__lastIpfsUrl = auditResult.ipfs_url;
                  }
                  
                  // ä¿å­˜ audit_id åˆ°å…¨å±€è®Šæ•¸ï¼ˆç”¨æ–¼çµæœé¡¯ç¤ºï¼‰
                  window.__lastAuditId = auditResult.audit_id;
                  
                  // æ›´æ–° localStorage ä¸­çš„è¨˜éŒ„ï¼ˆæ·»åŠ  audit_id å’Œ IPFS CIDï¼‰
                  // æ³¨æ„ï¼šé€™äº›æ¬„ä½ä¸æœƒå½±éŸ¿ record_hashï¼Œå› ç‚º hash è¨ˆç®—æ™‚å·²æ’é™¤é€™äº›æ¬„ä½
                  const updatedLine = JSON.stringify(auditEntry);
                  // éœ€è¦æ‰¾åˆ°ä¸¦æ›¿æ›å°æ‡‰çš„è¡Œï¼ˆè€Œä¸æ˜¯è¿½åŠ ï¼‰
                  const lines = existingLog.split('\n').filter(line => line.trim());
                  // æ‰¾åˆ°æœ€å¾Œä¸€è¡Œï¼ˆæ‡‰è©²æ˜¯æœ€æ–°æ·»åŠ çš„ï¼‰
                  if (lines.length > 0) {
                    // æ›¿æ›æœ€å¾Œä¸€è¡Œ
                    lines[lines.length - 1] = updatedLine;
                    const updatedLog = lines.join('\n');
                    localStorage.setItem('audit_log_jsonl', updatedLog);
                  } else {
                    localStorage.setItem('audit_log_jsonl', updatedLine);
                  }
                } else {
                  console.warn('å¾Œç«¯ä¿å­˜ audit log å¤±æ•—:', auditResp.status);
                  auditEntry.audit_saved = false;
                  auditEntry.audit_error = `HTTP ${auditResp.status}`;
                  window.__lastAuditId = null;
                }
              } catch (e) {
                console.warn('ç™¼é€ audit log åˆ°å¾Œç«¯å¤±æ•—:', e);
                auditEntry.audit_saved = false;
                auditEntry.audit_error = String(e);
                // é¡¯ç¤ºéŒ¯èª¤åˆ°é é¢ï¼ˆå¹«åŠ©èª¿è©¦ï¼‰
                console.error('âŒ Audit log ä¿å­˜å¤±æ•—:', e);
              }
              
              // è§¸ç™¼ statusSummary æ›´æ–°
              const event = new CustomEvent('auditLogUpdated');
              window.dispatchEvent(event);
            } catch (e) {
              console.error('ä¿å­˜ audit log å¤±æ•—:', e);
            }
          }
          
          // æ›´æ–°ç‹€æ…‹æŒ‡ç¤ºå™¨
          if (data.capsuleHash || data.capsule_hash) {
            const lastCapsuleEl = document.getElementById('lastCapsule');
            const lastVerifiedTimeEl = document.getElementById('lastVerifiedTime');
            if (lastCapsuleEl) {
              const capsuleHash = data.capsuleHash || data.capsule_hash;
              const shortHash = capsuleHash.length > 20 
                ? capsuleHash.slice(0, 10) + '...' + capsuleHash.slice(-8)
                : capsuleHash;
              lastCapsuleEl.textContent = shortHash;
              lastCapsuleEl.style.color = '#2563eb';
            }
            if (lastVerifiedTimeEl) {
              const now = new Date();
              const timeStr = now.toLocaleString('zh-TW', { 
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit', second: '2-digit'
              });
              lastVerifiedTimeEl.textContent = timeStr;
              
              // æ›´æ–°å»¶é²ï¼ˆåŸºæ–¼å¯¦éš›è«‹æ±‚æ™‚é–“ï¼‰
              const latencyEl = document.getElementById('latency');
              if (latencyEl) {
                latencyEl.textContent = (elapsed / 1000).toFixed(1) + 's';
              }
              
              // æ¨¡æ“¬ Block Height æ›´æ–°ï¼ˆæ¯æ¬¡é©—è­‰å¾Œå¢åŠ ï¼‰
              const blockHeightEl = document.getElementById('blockHeight');
              if (blockHeightEl) {
                const currentHeight = parseInt(blockHeightEl.textContent.replace(/,/g, '') || '8594544');
                blockHeightEl.textContent = (currentHeight + 1).toLocaleString();
              }
            }
          }
          
          // å­˜å„²çµæœä»¥ä¾¿å¾ŒçºŒæŸ¥çœ‹ Trace
          window.__lastTestResult = data;
          window.__lastScenario = selectedScenario;
          
          // å¦‚æœè¿”å›äº† proof_ref æˆ– capsuleHashï¼Œé¡¯ç¤º Trace æŒ‰éˆ•
          const btnViewTrace = document.getElementById('btnViewTrace');
          if (btnViewTrace && (data.proof_ref || data.capsuleHash || data.trace)) {
            btnViewTrace.style.display = 'inline-block';
          }
          
          // DAO ææ¡ˆé©—è­‰çµæœï¼ˆDAO â†’ RWA â†’ Audit éˆè·¯ç‰¹æ®Šè™•ç†ï¼‰
          if (selectedScenario === 'dao' && data.status === 'verified' && data.context === 'dao-proposal-verification') {
            let resultHtml = `
              <div style="padding:16px;background:#f0fdf4;border-radius:8px;border-left:4px solid #3b82f6;">
                <strong style="font-size:16px;color:#3b82f6;">âœ… DAO ç« ç¨‹ææ¡ˆé©—è­‰æˆåŠŸ</strong><br>
                <small style="color:#6b7280;">è€—æ™‚ï¼š${elapsed}ms (${(elapsed/1000).toFixed(2)}ç§’)</small><br>
                <div style="margin-top:16px;">
                  <div style="padding:12px;background:white;border-radius:6px;margin-bottom:12px;">
                    <strong style="color:#1f2937;font-size:14px;">ğŸ“‹ ææ¡ˆè³‡è¨Šï¼š</strong><br>
                    <div style="margin-top:8px;font-size:13px;">
                      <strong>ææ¡ˆ IDï¼š</strong><code style="font-size:11px;background:#f3f4f6;padding:2px 6px;border-radius:4px;">${data.proposal_id || 'N/A'}</code><br>
                      <strong>æ–‡ä»¶é¡å‹ï¼š</strong>${data.doc_type_label || data.doc_type || 'ç« ç¨‹ææ¡ˆ'}<br>
                      <strong>æ–‡ä»¶é›œæ¹Šï¼š</strong><code style="font-size:11px;background:#f3f4f6;padding:2px 6px;border-radius:4px;">${data.doc_hash ? (data.doc_hash.length > 50 ? data.doc_hash.slice(0, 30) + '...' + data.doc_hash.slice(-10) : data.doc_hash) : 'N/A'}</code>
                    </div>
                  </div>
            `;
            
            // é¡¯ç¤º DAO â†’ RWA â†’ Audit å¯©è¨ˆéˆ
            if (data.audit_chain && Array.isArray(data.audit_chain)) {
              resultHtml += `
                <div style="margin-top:12px;padding:12px;background:#eff6ff;border-left:4px solid #3b82f6;border-radius:6px;">
                  <strong style="color:#1e40af;font-size:14px;">ğŸ”— DAO â†’ RWA â†’ Audit å¯©è¨ˆéˆ</strong><br>
                  <div style="margin-top:8px;font-family:monospace;font-size:12px;line-height:1.8;color:#1e293b;">
              `;
              data.audit_chain.forEach((entry, index) => {
                const ts = new Date(entry.timestamp).toLocaleString('zh-TW', { 
                  year: 'numeric', month: '2-digit', day: '2-digit',
                  hour: '2-digit', minute: '2-digit', second: '2-digit'
                });
                const stageEmoji = entry.stage === 'DAO_PROPOSAL' ? 'ğŸ›ï¸' : entry.stage === 'RWA_COMPLIANCE' ? 'ğŸ ' : 'ğŸ“‹';
                resultHtml += `${ts} | ${stageEmoji} ${entry.stage} | ${entry.action} | ${entry.details}<br>`;
              });
              resultHtml += `
                  </div>
                </div>
              `;
              
              // é¡¯ç¤ºå¯©è¨ˆæ‘˜è¦
              if (data.audit_summary) {
                resultHtml += `
                  <div style="margin-top:12px;padding:12px;background:#f9fafb;border-radius:6px;font-size:13px;">
                    <strong style="color:#1f2937;font-size:14px;">ğŸ“Š å¯©è¨ˆæ‘˜è¦ï¼š</strong><br>
                    <div style="margin-top:8px;color:#6b7280;">
                      <div style="margin-bottom:4px;">${data.audit_summary.dao_stage || ''}</div>
                      <div style="margin-bottom:4px;">${data.audit_summary.rwa_stage || ''}</div>
                      <div style="margin-bottom:4px;">${data.audit_summary.audit_stage || ''}</div>
                      ${data.audit_summary.chain_complete ? '<div style="margin-top:8px;color:#10b981;font-weight:bold;">âœ… å¯©è¨ˆéˆå®Œæ•´ï¼šDAO â†’ RWA â†’ Audit ä¸€ç·šè²«é€š</div>' : ''}
                    </div>
                  </div>
                `;
              }
            }
            
            // é¡¯ç¤º Capsule Hash
            if (data.capsuleHash) {
              resultHtml += `
                <div style="margin-top:12px;padding:8px;background:#f3f4f6;border-radius:6px;font-size:12px;">
                  <strong>ğŸ§© Proposal Capsule:</strong><br>
                  capsuleHash: <code style="font-size:11px;">${data.capsuleHash.length > 50 ? data.capsuleHash.slice(0, 30) + '...' + data.capsuleHash.slice(-10) : data.capsuleHash}</code>
                </div>
              `;
            }
            
            // é¡¯ç¤º proof_refï¼ˆå¦‚æœæœ‰çš„è©±ï¼Œè¡¨ç¤ºèˆ‡æˆæ¬Šé—œè¯ï¼‰
            if (data.proof_ref) {
              resultHtml += `
                <div style="margin-top:12px;padding:8px;background:#eff6ff;border-radius:6px;font-size:12px;">
                  <strong>ğŸ”— æˆæ¬Šé—œè¯ï¼š</strong><br>
                  proof_ref: <code style="font-size:11px;">${data.proof_ref.length > 50 ? data.proof_ref.slice(0, 30) + '...' + data.proof_ref.slice(-10) : data.proof_ref}</code>
                </div>
              `;
            }
            
            // é¡¯ç¤ºç¶²è·¯è³‡è¨Š
            if (data.network || data.source || data.verifier) {
              resultHtml += `
                <div style="margin-top:12px;padding:8px;background:#f3f4f6;border-radius:6px;font-size:12px;">
                  <strong>ğŸŒ ç¶²è·¯è³‡è¨Šï¼š</strong><br>
                  ${data.network ? `network: <code>${data.network}</code><br>` : ''}
                  ${data.source ? `source: <code>${data.source}</code><br>` : ''}
                  ${data.verifier ? `verifier: <code>${data.verifier}</code><br>` : ''}
                  ${data.policy_module ? `policy_module: <code>${data.policy_module}</code><br>` : ''}
                  ${data.trust_policy_version ? `trust_policy_version: <code>${data.trust_policy_version}</code>` : ''}
                </div>
              `;
            }
            
            // é¡¯ç¤ºäººé¡å¯è®€æè¿°
            if (data.human_readable) {
              resultHtml += `
                <div style="margin-top:12px;padding:12px;background:#f0f9ff;border-left:4px solid #3b82f6;border-radius:6px;font-size:13px;">
                  <strong>ğŸ’¬ æè¿°ï¼š</strong><br>
                  <p style="margin-top:4px;color:#1e40af;">${data.human_readable}</p>
                </div>
              `;
            }
            
            resultHtml += `
                </div>
              </div>
            `;
            resultDiv.innerHTML = resultHtml;
            return;
          }
          
          // æ–‡ä»¶é›œæ¹Šé©—è­‰çµæœï¼ˆRWA æµç¨‹ç‰¹æ®Šè™•ç†ï¼‰
          if (selectedScenario === 'rwa' && data.status === 'verified' && data.context === 'document-hash-verification') {
            let resultHtml = `
              <div style="padding:16px;background:#f0fdf4;border-radius:8px;border-left:4px solid #10b981;">
                <strong style="font-size:16px;color:#10b981;">âœ… æ–‡ä»¶é›œæ¹Šé©—è­‰æˆåŠŸ</strong><br>
                <small style="color:#6b7280;">è€—æ™‚ï¼š${elapsed}ms (${(elapsed/1000).toFixed(2)}ç§’)</small><br>
                <div style="margin-top:16px;">
                  <div style="padding:12px;background:white;border-radius:6px;margin-bottom:12px;">
                    <strong style="color:#1f2937;font-size:14px;">ğŸ“„ æ–‡ä»¶è³‡è¨Šï¼š</strong><br>
                    <div style="margin-top:8px;font-size:13px;">
                      <strong>æ–‡ä»¶é¡å‹ï¼š</strong>${data.doc_type_label || data.doc_type || 'æœªçŸ¥'}<br>
                      <strong>æ–‡ä»¶é›œæ¹Šï¼š</strong><code style="font-size:11px;background:#f3f4f6;padding:2px 6px;border-radius:4px;">${data.doc_hash ? (data.doc_hash.length > 50 ? data.doc_hash.slice(0, 30) + '...' + data.doc_hash.slice(-10) : data.doc_hash) : 'N/A'}</code><br>
                    </div>
                  </div>
            `;
            
            // é¡¯ç¤º Capsule Hash
            if (data.capsuleHash) {
              resultHtml += `
                <div style="margin-top:12px;padding:8px;background:#f3f4f6;border-radius:6px;font-size:12px;">
                  <strong>ğŸ§© Document Capsule:</strong><br>
                  capsuleHash: <code style="font-size:11px;">${data.capsuleHash.length > 50 ? data.capsuleHash.slice(0, 30) + '...' + data.capsuleHash.slice(-10) : data.capsuleHash}</code>
                </div>
              `;
            }
            
            // é¡¯ç¤º proof_refï¼ˆå¦‚æœæœ‰çš„è©±ï¼Œè¡¨ç¤ºèˆ‡èº«ä»½é©—è­‰é—œè¯ï¼‰
            if (data.proof_ref) {
              resultHtml += `
                <div style="margin-top:12px;padding:8px;background:#eff6ff;border-radius:6px;font-size:12px;">
                  <strong>ğŸ”— èº«ä»½é©—è­‰é—œè¯ï¼š</strong><br>
                  proof_ref: <code style="font-size:11px;">${data.proof_ref.length > 50 ? data.proof_ref.slice(0, 30) + '...' + data.proof_ref.slice(-10) : data.proof_ref}</code>
                </div>
              `;
            }
            
            // é¡¯ç¤ºé©—è­‰è©³æƒ…
            if (data.verification_details) {
              resultHtml += `
                <div style="margin-top:12px;padding:12px;background:#f9fafb;border-radius:6px;font-size:12px;">
                  <strong>ğŸ” é©—è­‰è©³æƒ…ï¼š</strong><br>
                  <div style="margin-top:8px;color:#6b7280;font-size:12px;">
                    <strong>é›œæ¹Šç®—æ³•ï¼š</strong>${data.verification_details.hash_algorithm || 'N/A'}<br>
                    <strong>é©—è­‰æ–¹æ³•ï¼š</strong>${data.verification_details.verification_method || 'N/A'}<br>
                    <strong>æ™‚é–“æˆ³ï¼š</strong>${data.verification_details.timestamp ? new Date(data.verification_details.timestamp).toLocaleString('zh-TW') : 'N/A'}
                  </div>
                </div>
              `;
            }
            
            // é¡¯ç¤ºç¶²è·¯è³‡è¨Š
            if (data.network || data.source || data.verifier) {
              resultHtml += `
                <div style="margin-top:12px;padding:8px;background:#f3f4f6;border-radius:6px;font-size:12px;">
                  <strong>ğŸŒ ç¶²è·¯è³‡è¨Šï¼š</strong><br>
                  ${data.network ? `network: <code>${data.network}</code><br>` : ''}
                  ${data.source ? `source: <code>${data.source}</code><br>` : ''}
                  ${data.verifier ? `verifier: <code>${data.verifier}</code><br>` : ''}
                  ${data.policy_module ? `policy_module: <code>${data.policy_module}</code><br>` : ''}
                  ${data.trust_policy_version ? `trust_policy_version: <code>${data.trust_policy_version}</code>` : ''}
                </div>
              `;
            }
            
            // é¡¯ç¤ºäººé¡å¯è®€æè¿°
            if (data.human_readable) {
              resultHtml += `
                <div style="margin-top:12px;padding:12px;background:#f0f9ff;border-left:4px solid #3b82f6;border-radius:6px;font-size:13px;">
                  <strong>ğŸ’¬ æè¿°ï¼š</strong><br>
                  <p style="margin-top:4px;color:#1e40af;">${data.human_readable}</p>
                </div>
              `;
            }
            
            resultHtml += `
                </div>
              </div>
            `;
            resultDiv.innerHTML = resultHtml;
            return;
          }
          
          // ç¤¾äº¤è²è­½é©—è­‰çµæœï¼ˆç‰¹æ®Šè™•ç†ï¼‰
          if (selectedScenario === 'social' && data.status === 'verified') {
            const reputationScore = data.reputation_score || 0;
            const reputationLevel = data.reputation_level || 'medium';
            const levelColor = reputationScore >= 80 ? '#10b981' : reputationScore >= 60 ? '#f59e0b' : '#ef4444';
            const levelText = reputationScore >= 80 ? 'é«˜' : reputationScore >= 60 ? 'ä¸­' : 'ä½';
            
            // è¨ˆç®—è²è­½åˆ†æ•¸çš„é€²åº¦æ¢
            const percentage = reputationScore;
            const filledBlocks = Math.floor(percentage / 5); // æ¯5%ä¸€å€‹æ–¹å¡Šï¼Œå…±20å€‹
            const emptyBlocks = 20 - filledBlocks;
            
            let resultHtml = `
              <div style="padding:16px;background:#f0fdf4;border-radius:8px;border-left:4px solid ${levelColor};">
                <strong style="font-size:16px;color:${levelColor};">âœ… ç¤¾äº¤è²è­½é©—è­‰æˆåŠŸ</strong><br>
                <small style="color:#6b7280;">è€—æ™‚ï¼š${elapsed}ms (${(elapsed/1000).toFixed(2)}ç§’)</small><br>
                <div style="margin-top:16px;">
                  <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px;">
                    <strong style="color:${levelColor};font-size:18px;">â­ Reputation Score: ${reputationScore} / 100</strong>
                    <span style="padding:4px 12px;background:${levelColor};color:white;border-radius:12px;font-size:12px;font-weight:bold;">${levelText}è²è­½</span>
                  </div>
                  <div style="display:flex;align-items:center;gap:2px;font-family:monospace;font-size:16px;margin-bottom:8px;">
                    <span style="color:${levelColor};">${'â–ˆ'.repeat(filledBlocks)}</span>
                    <span style="color:#d1d5db;">${'â–‘'.repeat(emptyBlocks)}</span>
                  </div>
                </div>
            `;
            
            // é¡¯ç¤ºè²è­½å› ç´ 
            if (data.reputation_factors && Array.isArray(data.reputation_factors)) {
              resultHtml += `
                <div style="margin-top:12px;padding:12px;background:white;border-radius:6px;">
                  <strong style="color:#1f2937;font-size:14px;">ğŸ“Š è²è­½è©•ä¼°å› ç´ ï¼š</strong><br>
                  <ul style="margin-top:8px;padding-left:20px;color:#6b7280;font-size:13px;">
                    ${data.reputation_factors.map(factor => `<li>${factor}</li>`).join('')}
                  </ul>
                </div>
              `;
            }
            
            // é¡¯ç¤º Capsule Hash
            if (data.capsuleHash) {
              resultHtml += `
                <div style="margin-top:12px;padding:8px;background:#f3f4f6;border-radius:6px;font-size:12px;">
                  <strong>ğŸ§© Reputation Capsule:</strong><br>
                  capsuleHash: <code style="font-size:11px;">${data.capsuleHash.length > 50 ? data.capsuleHash.slice(0, 30) + '...' + data.capsuleHash.slice(-10) : data.capsuleHash}</code>
                </div>
              `;
            }
            
            // é¡¯ç¤ºç¶²è·¯è³‡è¨Š
            if (data.network || data.source || data.verifier) {
              resultHtml += `
                <div style="margin-top:12px;padding:8px;background:#f3f4f6;border-radius:6px;font-size:12px;">
                  <strong>ğŸŒ ç¶²è·¯è³‡è¨Šï¼š</strong><br>
                  ${data.network ? `network: <code>${data.network}</code><br>` : ''}
                  ${data.source ? `source: <code>${data.source}</code><br>` : ''}
                  ${data.verifier ? `verifier: <code>${data.verifier}</code><br>` : ''}
                  ${data.policy_module ? `policy_module: <code>${data.policy_module}</code><br>` : ''}
                  ${data.trust_policy_version ? `trust_policy_version: <code>${data.trust_policy_version}</code>` : ''}
                </div>
              `;
            }
            
            // é¡¯ç¤ºäººé¡å¯è®€æè¿°
            if (data.human_readable) {
              resultHtml += `
                <div style="margin-top:12px;padding:12px;background:#f0f9ff;border-left:4px solid #3b82f6;border-radius:6px;font-size:13px;">
                  <strong>ğŸ’¬ æè¿°ï¼š</strong><br>
                  <p style="margin-top:4px;color:#1e40af;">${data.human_readable}</p>
                </div>
              `;
            }
            
            resultHtml += `</div>`;
            resultDiv.innerHTML = resultHtml;
            return;
          }
          
          // æ§‹å»ºé¡¯ç¤ºå…§å®¹
          let resultHtml = `
            <div style="padding:12px;background:#f0fdf4;border-radius:8px;">
              <strong>âœ… æ¸¬è©¦æˆåŠŸ</strong><br>
              <small>è€—æ™‚ï¼š${elapsed}ms (${(elapsed/1000).toFixed(2)}ç§’)</small><br>
              ${data.status === 'verified' || data.status === 'authorized' ? 
                '<p style="color:#10b981;margin-top:8px;"><strong>âœ“ é©—è­‰é€šé</strong></p>' : ''}
          `;
          
          // é¡¯ç¤º actionsï¼ˆæ–°è¨­è¨ˆï¼‰
          if (data.actions && Array.isArray(data.actions)) {
            resultHtml += `<p style="margin-top:8px;"><strong>æˆæ¬Šè¡Œç‚ºï¼š</strong>${data.actions.map(a => {
              const labels = {
                'vote': 'æŠ•ç¥¨',
                'propose': 'ææ¡ˆ',
                'sign': 'ç°½ç½²',
                'whitelist': 'ç™½åå–®',
                'access': 'è¨ªå•',
              };
              return labels[a] || a;
            }).join('ã€')}</p>`;
          }
          
          // é¡¯ç¤ºæ¬Šé™
          if (data.permissions && Array.isArray(data.permissions)) {
            resultHtml += `<p style="margin-top:8px;"><strong>æ¬Šé™ï¼š</strong>${data.permissions.join(', ')}</p>`;
          }
          
          // é¡¯ç¤º proof_ref è¿½æº¯éˆ
          if (data.proof_ref || data.capsuleHash) {
            resultHtml += `<div style="margin-top:12px;padding:8px;background:#eff6ff;border-radius:6px;font-size:12px;">`;
            resultHtml += `<strong>ğŸ”— è¿½æº¯éˆï¼š</strong><br>`;
            if (data.proof_ref) {
              resultHtml += `proof_ref: <code style="font-size:11px;">${data.proof_ref.length > 50 ? data.proof_ref.slice(0, 30) + '...' + data.proof_ref.slice(-10) : data.proof_ref}</code><br>`;
            }
            if (data.capsuleHash) {
              resultHtml += `capsuleHash: <code style="font-size:11px;">${data.capsuleHash.length > 50 ? data.capsuleHash.slice(0, 30) + '...' + data.capsuleHash.slice(-10) : data.capsuleHash}</code>`;
            }
            resultHtml += `</div>`;
          }
          
          // é¡¯ç¤º Agent ç›¸é—œä¿¡æ¯ï¼ˆå¦‚æœæ˜¯ Agent æ¨¡å¼ï¼‰
          if (data.verification?.agent_signature || data.verification?.agentType === 'ai-agent' || data.can_delegate || data.sandbox_score) {
            resultHtml += `<div style="margin-top:12px;padding:8px;background:#fef3c7;border-radius:6px;font-size:12px;">`;
            resultHtml += `<strong>ğŸ¤– Proof-of-Agentï¼š</strong><br>`;
            if (data.verification?.agent_signature) {
              resultHtml += `agent_signature: <code style="font-size:11px;">${data.verification.agent_signature.slice(0, 20)}...${data.verification.agent_signature.slice(-10)}</code><br>`;
            }
            if (data.verification?.model) {
              resultHtml += `model: ${data.verification.model}<br>`;
            }
            // è¦–è¦ºåŒ–é¡¯ç¤º sandbox_scoreï¼ˆæˆåŠŸæ¡ˆä¾‹ï¼‰
            if (data.sandbox_score !== undefined || data.verification?.sandbox_score !== undefined) {
              const score = data.sandbox_score !== undefined ? data.sandbox_score : (data.verification?.sandbox_score || 0);
              const threshold = data.threshold !== undefined ? data.threshold : 0.9;
              const percentage = Math.min((score / threshold) * 100, 100);
              const scoreColor = score >= threshold ? '#10b981' : '#f59e0b';
              const filledBlocks = Math.floor(percentage / 5);
              const emptyBlocks = 20 - filledBlocks;
              
              resultHtml += `<div style="margin-top:8px;">`;
              resultHtml += `<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">`;
              resultHtml += `<span style="font-weight:bold;color:${scoreColor};">Sandbox Score: ${score.toFixed(2)} / ${threshold}</span>`;
              resultHtml += `</div>`;
              resultHtml += `<div style="display:flex;align-items:center;gap:2px;font-family:monospace;font-size:14px;">`;
              resultHtml += `<span style="color:${scoreColor};">${'â–ˆ'.repeat(filledBlocks)}</span>`;
              resultHtml += `<span style="color:#d1d5db;">${'â–‘'.repeat(emptyBlocks)}</span>`;
              resultHtml += `</div>`;
              resultHtml += `<p style="margin-top:4px;color:#92400e;font-size:11px;">${score >= threshold ? 'ï¼ˆå·²é”å®‰å…¨é–¾å€¼ï¼‰' : 'ï¼ˆæ¥è¿‘å®‰å…¨é–¾å€¼ï¼‰'}</p>`;
              resultHtml += `</div>`;
            }
            // é¡¯ç¤ºä¿¡ä»»æ”¿ç­–ç‰ˆæœ¬
            if (data.trust_policy_version) {
              resultHtml += `<p style="margin-top:8px;color:#6b7280;font-size:10px;">ä¿¡ä»»æ”¿ç­–ç‰ˆæœ¬: <code>${data.trust_policy_version}</code></p>`;
            }
            // é¡¯ç¤º Agent â†’ DAO ä»£ç†æ¬Šé™
            if (data.can_delegate !== undefined) {
              resultHtml += `<br><strong>ğŸ”— ä»£ç†æ¬Šé™ï¼š</strong><br>`;
              resultHtml += `can_delegate: ${data.can_delegate ? 'âœ… æ˜¯' : 'âŒ å¦'}<br>`;
              if (data.delegate_scope && Array.isArray(data.delegate_scope)) {
                resultHtml += `delegate_scope: ${data.delegate_scope.join(', ')}`;
              }
            }
            resultHtml += `</div>`;
          }
          
          // é¡¯ç¤ºäººé¡å¯è®€æè¿°
          if (data.human_readable) {
            resultHtml += `<div style="margin-top:12px;padding:12px;background:#f0f9ff;border-left:4px solid #3b82f6;border-radius:6px;font-size:13px;">`;
            resultHtml += `<strong>ğŸ’¬ æè¿°ï¼š</strong><br>`;
            resultHtml += `<p style="margin-top:4px;color:#1e40af;">${data.human_readable}</p>`;
            resultHtml += `</div>`;
          }
          
          // é¡¯ç¤º audit_id å’Œ IPFS CIDï¼ˆå¦‚æœå·²ä¿å­˜åˆ°å¾Œç«¯ï¼‰
          if (window.__lastAuditId) {
            resultHtml += `<div style="margin-top:12px;padding:8px;background:#dcfce7;border-left:3px solid #10b981;border-radius:6px;font-size:12px;">`;
            resultHtml += `<strong style="color:#166534;">âœ… å·²ä¿å­˜åˆ°å¾Œç«¯å„²å­˜</strong><br>`;
            resultHtml += `<span style="color:#166534;font-size:11px;">`;
            resultHtml += `Firestore ID: <code style="background:#fff;padding:2px 6px;border-radius:4px;font-family:ui-monospace;">${window.__lastAuditId}</code>`;
            
            // å¦‚æœæœ‰ IPFS CIDï¼Œé¡¯ç¤ºå®ƒ
            if (window.__lastIpfsCid) {
              resultHtml += `<br style="margin-top:6px;">`;
              resultHtml += `ğŸŒ IPFS CID: <code style="background:#fff;padding:2px 6px;border-radius:4px;font-family:ui-monospace;color:#3b82f6;">${window.__lastIpfsCid}</code>`;
              if (window.__lastIpfsUrl) {
                resultHtml += ` <a href="${window.__lastIpfsUrl}" target="_blank" style="color:#3b82f6;text-decoration:none;margin-left:6px;">ğŸ”— æŸ¥çœ‹</a>`;
              }
            }
            
            resultHtml += `</span>`;
            resultHtml += `</div>`;
          }
          
          // é¡¯ç¤ºç¶²è·¯ä¿¡æ¯ï¼ˆåŒ…å« verifier å’Œ policy_moduleï¼‰
          if (data.network || data.source || data.verifier || data.trust_policy_version) {
            resultHtml += `<div style="margin-top:12px;padding:8px;background:#f3f4f6;border-radius:6px;font-size:12px;">`;
            resultHtml += `<strong>ğŸŒ ç¶²è·¯è³‡è¨Šï¼š</strong><br>`;
            if (data.network) {
              resultHtml += `network: <code>${data.network}</code><br>`;
            }
            if (data.source) {
              resultHtml += `source: <code>${data.source}</code><br>`;
            }
            if (data.verifier) {
              resultHtml += `verifier: <code>${data.verifier}</code><br>`;
            }
            // é¡¯ç¤º policy_moduleï¼ˆæ¨¡çµ„åŒ–å¯æ›¿æ›ï¼‰
            const policyModule = data.policy_module || (data.audit_log?.policy_module) || 'AgentTrustPolicyV1';
            resultHtml += `policy_module: <code>${policyModule}</code><br>`;
            
            // é¡¯ç¤ºéˆä¸Šè³‡è¨Šï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
            if (data.blockNumber || data.timestamp || data.gasUsed) {
              resultHtml += `<div style="margin-top:8px;padding:8px;background:#eff6ff;border-left:3px solid #3b82f6;border-radius:4px;">`;
              resultHtml += `<strong style="color:#1e40af;">ğŸ”— éˆä¸Šäº’å‹•ç´°ç¯€ï¼š</strong><br>`;
              if (data.blockNumber) {
                resultHtml += `blockNumber: <code style="font-size:11px;">${data.blockNumber}</code><br>`;
              }
              if (data.timestamp) {
                const ts = new Date(data.timestamp).toLocaleString('zh-TW');
                resultHtml += `timestamp: <code style="font-size:11px;">${ts}</code><br>`;
              }
              if (data.gasUsed) {
                resultHtml += `gasUsed: <code style="font-size:11px;">${data.gasUsed}</code><br>`;
              }
              resultHtml += `<p style="margin-top:6px;font-size:11px;color:#6b7280;font-style:italic;">ä¾†æºåˆç´„ï¼šSelf Onchain Verifier (Celo)</p>`;
              resultHtml += `</div>`;
            }
            
            resultHtml += `</div>`;
          }
          
          resultHtml += `
              <details style="margin-top:8px;">
                <summary style="cursor:pointer;color:#3b82f6;">æŸ¥çœ‹å®Œæ•´å›æ‡‰</summary>
                <pre style="font-size:12px;overflow:auto;max-height:200px;margin-top:8px;padding:8px;background:#f9fafb;border-radius:4px;">${JSON.stringify(data, null, 2)}</pre>
              </details>
            </div>
          `;
          
          resultDiv.innerHTML = resultHtml;
        } catch(e) {
          console.error('æ¸¬è©¦å¤±æ•—ï¼š', e);
          const errorMsg = String(e);
          resultDiv.innerHTML = `<div style="padding:12px;background:#fee2e2;border-radius:8px;color:#b91c1c;">
            <strong>âŒ æ¸¬è©¦å¤±æ•—</strong><br>
            <p style="margin-top:4px;font-size:13px;">${errorMsg}</p>
            <p style="margin-top:8px;font-size:12px;color:#6b7280;">
              <strong>æç¤ºï¼š</strong><br>
              â€¢ å¦‚æœæ˜¯ HTTP 404ï¼Œè«‹ç¢ºèª Firebase Functions å·²éƒ¨ç½²æˆ–æœ¬åœ° emulator æ­£åœ¨é‹è¡Œ<br>
              â€¢ æœ¬åœ°é–‹ç™¼ï¼šè«‹åŸ·è¡Œ <code style="background:#f3f4f6;padding:2px 4px;border-radius:3px;">firebase emulators:start</code><br>
              â€¢ æª¢æŸ¥ <code style="background:#f3f4f6;padding:2px 4px;border-radius:3px;">firebase.json</code> ä¸­çš„ rewrites é…ç½®æ˜¯å¦æ­£ç¢º
            </p>
          </div>`;
        }
      }
      
      // å°‡å‡½æ•¸æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸ
      window.testScenario = testScenario;

      // æŸ¥çœ‹æ€§èƒ½çµ±è¨ˆ
      async function viewPerformance() {
        const perfDiv = document.getElementById('perfStats');
        const perfContent = document.getElementById('perfContent');
        perfDiv.style.display = 'block';
        perfContent.innerHTML = '<p>è¼‰å…¥ä¸­...</p>';
        
        try {
          // ä½¿ç”¨ API_BASE_URLï¼ˆå¦‚æœå·²é…ç½®ï¼‰æˆ–ä½¿ç”¨ç›¸å°è·¯å¾‘
          const apiBase = window.API_BASE_URL || '';
          const fullUrl = apiBase + '/api/performance/stats';
          
          const resp = await fetch(fullUrl);
          
          if (!resp.ok) {
            throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
          }
          
          // æª¢æŸ¥å›æ‡‰æ˜¯å¦ç‚º JSON
          const contentType = resp.headers.get('content-type');
          if (!contentType || !contentType.includes('application/json')) {
            const text = await resp.text();
            throw new Error(`é æœŸ JSON ä½†æ”¶åˆ°ï¼š${contentType}ã€‚å›æ‡‰ï¼š${text.substring(0, 100)}`);
          }
          
          const data = await resp.json();
          
          let html = '';
          if (data.total_requests === 0) {
            html = '<p>' + data.note + '</p>';
          } else {
            html = `
              <p><strong>ç¸½è«‹æ±‚æ•¸ï¼š</strong>${data.total_requests}</p>
              <p><strong>å¹³å‡è€—æ™‚ï¼š</strong>${data.average_time_ms}ms (${data.average_time_sec}ç§’)</p>
              <p><strong>æœ€å°/æœ€å¤§ï¼š</strong>${data.min_time_ms}ms / ${data.max_time_ms}ms</p>
              <p><strong>P50 / P95 / P99ï¼š</strong>${data.p50_time_ms}ms / ${data.p95_time_ms}ms / ${data.p99_time_ms}ms</p>
            `;
            
            if (Object.keys(data.by_endpoint).length > 0) {
              html += '<h4 style="margin-top:12px;">æŒ‰ç«¯é»çµ±è¨ˆï¼š</h4>';
              Object.keys(data.by_endpoint).forEach(endpoint => {
                const stat = data.by_endpoint[endpoint];
                html += `<p>â€¢ <strong>${endpoint}</strong>ï¼š${stat.count} æ¬¡ï¼Œå¹³å‡ ${stat.average_sec}ç§’</p>`;
              });
            }
            
            if (Object.keys(data.by_mode).length > 0) {
              html += '<h4 style="margin-top:12px;">æŒ‰æ¨¡å¼çµ±è¨ˆï¼š</h4>';
              Object.keys(data.by_mode).forEach(mode => {
                const stat = data.by_mode[mode];
                html += `<p>â€¢ <strong>${mode}</strong>ï¼š${stat.count} æ¬¡ï¼Œå¹³å‡ ${stat.average_sec}ç§’</p>`;
              });
            }
          }
          
          perfContent.innerHTML = html;
        } catch(e) {
          console.error('æ€§èƒ½çµ±è¨ˆè¼‰å…¥å¤±æ•—ï¼š', e);
          perfContent.innerHTML = `<p style="color:#b91c1c;">è¼‰å…¥å¤±æ•—ï¼š${String(e)}</p>`;
        }
      }
      
      // å°‡å‡½æ•¸æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸ
      window.viewPerformance = viewPerformance;
      
      // æ¸¬è©¦ Denylist å ´æ™¯ï¼šäººé€šéä½† Agent è¢« ban
      window.testDenylist = async function() {
        const resultDiv = document.getElementById('testResult');
        resultDiv.innerHTML = '<p style="color:#6b7280;">â³ æ¸¬è©¦ Denylist å ´æ™¯ä¸­...</p>';
        
        try {
          // æ¨¡æ“¬ï¼šå…ˆé©—è­‰äººï¼ˆé€šéï¼‰ï¼Œå†é©—è­‰ Agentï¼ˆè¢« banï¼‰
          const verifyResp = await fetch('/api/self/verify-by-tx', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ txHash: 'DEMO_SUCCESS_TW' }),
          });
          
          if (!verifyResp.ok) {
            throw new Error(`HTTP ${verifyResp.status}`);
          }
          
          const verifyData = await verifyResp.json();
          
          // ç„¶å¾Œæ¸¬è©¦ Agentï¼ˆè¢« banï¼‰
          const agentResp = await fetch('/api/agent/verify', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              agentAddress: 'DEMO_FAIL_AGENT_NOT_TRUSTED',
              policy: 'agent-policy'
            }),
          });
          
          if (!agentResp.ok) {
            throw new Error(`HTTP ${agentResp.status}`);
          }
          
          const agentData = await agentResp.json();
          
          // é¡¯ç¤ºå…©å±¤ä¿¡ä»»ä¸åŒæ­¥çš„çµæœ
          let resultHtml = `
            <div style="padding:16px;background:#fff7ed;border-radius:8px;border-left:4px solid #f59e0b;">
              <strong style="font-size:16px;color:#f59e0b;">âš ï¸ Human â†” Agent å…©å±¤ä¿¡ä»»ä¸åŒæ­¥</strong><br>
              <div style="margin-top:16px;">
                <div style="padding:12px;background:#f0fdf4;border-radius:6px;margin-bottom:12px;border-left:3px solid #10b981;">
                  <strong style="color:#10b981;">âœ… äººï¼šé©—è­‰é€šé</strong><br>
                  <div style="margin-top:8px;font-size:13px;">
                    <strong>åœ‹å®¶/åœ°å€ï¼š</strong>${verifyData.country || 'TW'}<br>
                    <strong>å¹´é½¡é©—è­‰ï¼š</strong>${verifyData.age_verified ? 'âœ… é€šé' : 'âŒ æœªé€šé'}<br>
                    <strong>OFAC æª¢æŸ¥ï¼š</strong>${verifyData.ofac_checked ? 'âœ… é€šé' : 'âŒ æœªé€šé'}<br>
                    ${verifyData.capsuleHash ? `<strong>Capsule Hash:</strong> <code style="font-size:11px;">${verifyData.capsuleHash.slice(0, 20)}...${verifyData.capsuleHash.slice(-10)}</code>` : ''}
                  </div>
                </div>
                
                <div style="padding:12px;background:#fee2e2;border-radius:6px;margin-bottom:12px;border-left:3px solid #ef4444;">
                  <strong style="color:#ef4444;">âŒ Agentï¼šè¢«æ‹’çµ•</strong><br>
                  <div style="margin-top:8px;font-size:13px;">
                    <strong>åŸå› ï¼š</strong>${agentData.reason || 'AGENT_NOT_IN_WHITELIST'}<br>
                    ${agentData.sandbox_score !== undefined ? `<strong>Sandbox Score:</strong> ${agentData.sandbox_score.toFixed(2)} / ${agentData.threshold || 0.9}ï¼ˆå®‰å…¨é–¾å€¼æœªé”ï¼‰` : ''}
                    ${agentData.delegation_scope ? `<br><strong>æœªæˆæ¬Šç¯„ç–‡ï¼š</strong>${agentData.delegation_scope.join(', ')}` : ''}
                  </div>
                </div>
                
                <div style="padding:12px;background:#f3f4f6;border-radius:6px;font-size:13px;">
                  <strong style="color:#1f2937;">ğŸ“Š çµæœï¼š</strong><br>
                  <p style="margin-top:6px;color:#6b7280;">
                    äººå¯ä»¥é€²å…¥ç³»çµ±ï¼Œä½†ä¸èƒ½å§”æ´¾çµ¦é€™å€‹ Agentã€‚<br>
                    é€™å±•ç¤ºäº† <strong>Human â†” Agent å…©å±¤ trust ä¸åŒæ­¥</strong> çš„å ´æ™¯ã€‚
                  </p>
                </div>
              </div>
            </div>
          `;
          
          resultDiv.innerHTML = resultHtml;
        } catch(e) {
          console.error('Denylist å ´æ™¯æ¸¬è©¦å¤±æ•—ï¼š', e);
          resultDiv.innerHTML = `<div style="padding:12px;background:#fee2e2;border-radius:8px;color:#b91c1c;">
            <strong>âŒ æ¸¬è©¦å¤±æ•—</strong><br>
            <p style="margin-top:4px;font-size:13px;">${String(e)}</p>
          </div>`;
        }
      };
      
      // é©—è­‰ audit log éˆçš„å®Œæ•´æ€§
      async function verifyChainIntegrity(entries) {
        const errors = [];
        const warnings = [];
        
        // è¨ˆç®— record_hash çš„å‡½æ•¸ï¼ˆèˆ‡å‰ç«¯ç”Ÿæˆæ™‚ä¸€è‡´ï¼‰
        // æ³¨æ„ï¼šéœ€è¦æ’é™¤å¾Œç«¯æ·»åŠ çš„æ¬„ä½ï¼ˆaudit_id, ipfs_cid, ipfs_url, audit_saved, audit_error, created_at ç­‰ï¼‰
        async function calculateRecordHash(data) {
          // æ’é™¤ record_hash æœ¬èº«ï¼Œä»¥åŠå¾Œç«¯æ·»åŠ çš„æ¬„ä½
          const excludedFields = [
            'record_hash',
            'audit_id',
            'ipfs_cid',
            'ipfs_url',
            'audit_saved',
            'audit_error',
            'created_at',
            'source',  // é€™å€‹æ˜¯å¾Œç«¯æ·»åŠ çš„
            'version'  // é€™å€‹æ˜¯å¾Œç«¯æ·»åŠ çš„
          ];
          
          const hashData = {};
          Object.keys(data).forEach(key => {
            if (!excludedFields.includes(key)) {
              hashData[key] = data[key];
            }
          });
          
          // ç©©å®šæ’åºçš„ JSON å­—ç¬¦ä¸²
          const sortedKeys = Object.keys(hashData).sort();
          const jsonObj = {};
          sortedKeys.forEach(key => jsonObj[key] = hashData[key]);
          const jsonString = JSON.stringify(jsonObj);
          const encoder = new TextEncoder();
          const dataBuf = encoder.encode(jsonString);
          const hashBuf = await crypto.subtle.digest('SHA-256', dataBuf);
          const hashArray = Array.from(new Uint8Array(hashBuf));
          return '0x' + hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }
        
        // æ‰¾åˆ°ç¬¬ä¸€ç­†æœ‰ record_hash çš„è¨˜éŒ„
        let firstHashIndex = -1;
        for (let i = 0; i < entries.length; i++) {
          if (entries[i].record_hash) {
            firstHashIndex = i;
            break;
          }
        }
        
        // å¦‚æœæœ‰èˆŠè¨˜éŒ„ï¼ˆæ²’æœ‰ record_hashï¼‰ï¼Œæ·»åŠ è­¦å‘Š
        if (firstHashIndex > 0) {
          warnings.push(`å‰ ${firstHashIndex} ç­†è¨˜éŒ„æ˜¯èˆŠæ ¼å¼ï¼ˆåœ¨å¯¦ç¾ hash chain ä¹‹å‰ï¼‰ï¼Œå·²è·³éé©—è­‰`);
        }
        
        // åªé©—è­‰æœ‰ record_hash çš„è¨˜éŒ„ï¼ˆå¾ç¬¬ä¸€ç­†é–‹å§‹ï¼‰
        if (firstHashIndex === -1) {
          warnings.push('æ‰€æœ‰è¨˜éŒ„éƒ½æ˜¯èˆŠæ ¼å¼ï¼ˆæ²’æœ‰ record_hashï¼‰ï¼Œç„¡æ³•é©—è­‰éˆå®Œæ•´æ€§');
          return { errors, warnings, chainValid: false };
        }
        
        // å¾ç¬¬ä¸€ç­†æœ‰ record_hash çš„è¨˜éŒ„é–‹å§‹é©—è­‰
        for (let i = firstHashIndex; i < entries.length; i++) {
          const entry = entries[i];
          
          // é©—è­‰ record_hash æ˜¯å¦æ­£ç¢º
          if (entry.record_hash) {
            const expectedHash = await calculateRecordHash(entry);
            if (entry.record_hash !== expectedHash) {
              errors.push(`è¨˜éŒ„ #${i + 1}: record_hash ä¸åŒ¹é…ï¼ˆå¯èƒ½è¢«ç¯¡æ”¹ï¼‰`);
            }
          }
          
          // é©—è­‰ prev_hash æ˜¯å¦èˆ‡ä¸Šä¸€ç­†çš„ record_hash åŒ¹é…
          if (entry.prev_hash) {
            // æ‰¾åˆ°ä¸Šä¸€ç­†æœ‰ record_hash çš„è¨˜éŒ„
            let prevEntry = null;
            for (let j = i - 1; j >= 0; j--) {
              if (entries[j].record_hash) {
                prevEntry = entries[j];
                break;
              }
            }
            
            if (prevEntry) {
              // å¦‚æœä¸Šä¸€ç­†æœ‰ record_hashï¼Œå¿…é ˆåŒ¹é…
              if (entry.prev_hash !== prevEntry.record_hash) {
                errors.push(`è¨˜éŒ„ #${i + 1}: prev_hash èˆ‡ä¸Šä¸€ç­† record_hash ä¸åŒ¹é…ï¼ˆéˆæ–·è£‚ï¼‰`);
              }
            } else {
              // å¦‚æœæ˜¯ç¬¬ä¸€ç­†æœ‰ record_hash çš„è¨˜éŒ„ï¼Œprev_hash æ‡‰è©²ç‚º null
              if (entry.prev_hash !== null && i === firstHashIndex) {
                warnings.push(`è¨˜éŒ„ #${i + 1}: é€™æ˜¯ç¬¬ä¸€ç­†æœ‰ record_hash çš„è¨˜éŒ„ï¼Œprev_hash æ‡‰ç‚º null`);
              }
            }
          }
        }
        
        return { errors, warnings, chainValid: errors.length === 0 };
      }
      
      // é‡æ’­é©—è­‰æµç¨‹ï¼šé¡¯ç¤º JSONL logs
      window.replayAuditLog = async function() {
        const raw = localStorage.getItem('audit_log_jsonl') || '';
        if (!raw.trim()) {
          alert('ç›®å‰æ²’æœ‰å¯©è¨ˆæ—¥èªŒè¨˜éŒ„');
          return;
        }
        
        const entries = raw.split(/\r?\n/).filter(Boolean).map(line => {
          try { return JSON.parse(line); } catch { return null; }
        }).filter(Boolean);
        
        if (entries.length === 0) {
          alert('å¯©è¨ˆæ—¥èªŒæ ¼å¼éŒ¯èª¤æˆ–ç‚ºç©º');
          return;
        }
        
        // é©—è­‰éˆçš„å®Œæ•´æ€§
        const chainResult = await verifyChainIntegrity(entries);
        const chainValid = chainResult.chainValid;
        const chainErrors = chainResult.errors;
        const chainWarnings = chainResult.warnings || [];
        
        // å‰µå»º Modal
        const modalDiv = document.createElement('div');
        modalDiv.id = 'replayAuditModal';
        modalDiv.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:24px;border-radius:12px;box-shadow:0 8px 16px rgba(0,0,0,0.2);max-width:900px;max-height:80vh;overflow:auto;z-index:1000;';
        
        // å‰µå»ºé—œé–‰å‡½æ•¸
        const closeModal = () => {
          const modal = document.getElementById('replayAuditModal');
          if (modal) {
            modal.remove();
          }
        };
        
        let html = `
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;border-bottom:2px solid #e5e7eb;padding-bottom:12px;">
            <div>
              <h3 style="margin:0;color:#1f2937;font-size:18px;">ğŸ”„ é‡æ’­é©—è­‰æµç¨‹ï¼ˆå¯©è¨ˆæ–¹è¦–åœ–ï¼‰</h3>
              <p style="margin:4px 0 0 0;color:#6b7280;font-size:12px;">å…± ${entries.length} ç­†é©—è­‰è¨˜éŒ„</p>
            </div>
            <button onclick="document.getElementById('replayAuditModal')?.remove()" style="background:#ef4444;color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:14px;">âœ• é—œé–‰</button>
          </div>
          ${chainValid 
            ? `<div style="background:#dcfce7;border-left:4px solid #10b981;padding:12px;border-radius:6px;margin-bottom:16px;">
                 <strong style="color:#166534;">âœ… éˆå®Œæ•´æ€§é©—è­‰é€šé</strong><br>
                 <p style="margin-top:6px;color:#166534;font-size:12px;">æ‰€æœ‰è¨˜éŒ„çš„ record_hash æ­£ç¢ºï¼Œprev_hash éˆæ¢å®Œæ•´ã€‚åªè¦ä¸­é–“æœ‰äººæ”¹ä¸€ç­†ï¼Œå¾Œé¢å…¨å£ã€‚</p>
                 ${chainWarnings.length > 0 ? `<div style="margin-top:8px;padding:8px;background:#fff7ed;border-radius:4px;font-size:11px;color:#92400e;">
                   <strong>â„¹ï¸ æç¤ºï¼š</strong> ${chainWarnings.join('; ')}
                 </div>` : ''}
               </div>`
            : `<div style="background:#fee2e2;border-left:4px solid #ef4444;padding:12px;border-radius:6px;margin-bottom:16px;">
                 <strong style="color:#991b1b;">âŒ éˆå®Œæ•´æ€§é©—è­‰å¤±æ•—</strong><br>
                 ${chainErrors.length > 0 ? `<p style="margin-top:6px;color:#991b1b;font-size:12px;">ç™¼ç¾ ${chainErrors.length} å€‹éŒ¯èª¤ï¼š</p>
                 <ul style="margin-top:6px;padding-left:20px;color:#991b1b;font-size:11px;">
                   ${chainErrors.map(e => `<li>${e}</li>`).join('')}
                 </ul>` : ''}
                 ${chainWarnings.length > 0 ? `<div style="margin-top:8px;padding:8px;background:#fff7ed;border-radius:4px;font-size:11px;color:#92400e;">
                   <strong>â„¹ï¸ æç¤ºï¼š</strong> ${chainWarnings.join('; ')}
                 </div>` : ''}
               </div>`
          }
          <div style="background:#f9fafb;padding:16px;border-radius:8px;font-family:ui-monospace;font-size:12px;max-height:500px;overflow:auto;">
        `;
        
        entries.forEach((entry, index) => {
          const ts = entry.timestamp ? new Date(entry.timestamp).toLocaleString('zh-TW') : 'N/A';
          html += `
            <div style="margin-bottom:16px;padding:12px;background:white;border-left:4px solid #3b82f6;border-radius:6px;">
              <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px;">
                <div>
                  <strong style="color:#1f2937;">è¨˜éŒ„ #${index + 1}</strong>
                  <span style="color:#6b7280;font-size:11px;margin-left:8px;">${ts}</span>
                </div>
                <span style="background:${entry.status === 'verified' || entry.status === 'allowed' ? '#dcfce7' : '#fee2e2'};color:${entry.status === 'verified' || entry.status === 'allowed' ? '#166534' : '#991b1b'};padding:4px 8px;border-radius:12px;font-size:11px;font-weight:600;">
                  ${entry.status === 'verified' || entry.status === 'allowed' ? 'âœ… é€šé' : 'âŒ æ‹’çµ•'}
                </span>
              </div>
              <div style="margin-top:8px;">
                <strong>Action:</strong> ${entry.action || 'N/A'}<br>
                ${entry.scenario ? `<strong>Scenario:</strong> ${entry.scenario}<br>` : ''}
                ${entry.policy ? `<strong>Policy:</strong> ${entry.policy}<br>` : ''}
                ${entry.prev_hash ? `<strong style="color:#6366f1;">ğŸ”— Prev Hash:</strong> <code style="font-size:11px;background:#ede9fe;padding:2px 6px;border-radius:4px;">${entry.prev_hash.slice(0, 10)}...${entry.prev_hash.slice(-8)}</code><br>` : '<strong style="color:#6366f1;">ğŸ”— Prev Hash:</strong> <code style="font-size:11px;background:#ede9fe;padding:2px 6px;border-radius:4px;">(é¦–ç­†è¨˜éŒ„)</code><br>'}
                ${entry.record_hash ? `<strong style="color:#2563eb;">ğŸ§¾ Record Hash:</strong> <code style="font-size:11px;background:#dbeafe;padding:2px 6px;border-radius:4px;">${entry.record_hash.slice(0, 10)}...${entry.record_hash.slice(-8)}</code><br>` : ''}
                ${entry.capsuleHash ? `<strong>Capsule Hash:</strong> <code style="font-size:11px;background:#f3f4f6;padding:2px 6px;border-radius:4px;">${entry.capsuleHash.slice(0, 20)}...${entry.capsuleHash.slice(-10)}</code><br>` : ''}
                ${entry.audit_id ? `<strong style="color:#10b981;">âœ… Audit ID:</strong> <code style="font-size:11px;background:#dcfce7;padding:2px 6px;border-radius:4px;color:#166534;">${entry.audit_id}</code>ï¼ˆå·²ä¿å­˜åˆ° Firestoreï¼‰<br>` : ''}
                ${entry.ipfs_cid ? `<strong style="color:#3b82f6;">ğŸŒ IPFS CID:</strong> <code style="font-size:11px;background:#dbeafe;padding:2px 6px;border-radius:4px;color:#1e40af;">${entry.ipfs_cid}</code>${entry.ipfs_url ? ` <a href="${entry.ipfs_url}" target="_blank" style="color:#3b82f6;text-decoration:none;">ğŸ”— æŸ¥çœ‹</a>` : ''}<br>` : ''}
                ${entry.audit_saved === false ? `<strong style="color:#ef4444;">âš ï¸ å¾Œç«¯ä¿å­˜å¤±æ•—:</strong> ${entry.audit_error || 'Unknown error'}<br>` : ''}
              </div>
              <details style="margin-top:8px;">
                <summary style="cursor:pointer;color:#3b82f6;font-size:11px;">æŸ¥çœ‹å®Œæ•´ JSON</summary>
                <pre style="margin-top:8px;padding:8px;background:#f9fafb;border-radius:4px;font-size:11px;overflow:auto;max-height:200px;">${JSON.stringify(entry, null, 2)}</pre>
              </details>
            </div>
          `;
        });
        
        html += `
          </div>
          <div style="margin-top:16px;padding-top:16px;border-top:1px solid #e5e7eb;">
            <p style="color:#6b7280;font-size:12px;line-height:1.6;">
              <strong>å¯©è¨ˆèªªæ˜ï¼š</strong><br>
              æ­¤è¦–åœ–å±•ç¤ºäº†å®Œæ•´çš„é©—è­‰æµç¨‹è¨˜éŒ„ï¼Œå¯ä¾›å¯©è¨ˆæ–¹é‡æ’­é©—è­‰éç¨‹ã€‚æ¯ç­†è¨˜éŒ„åŒ…å«æ™‚é–“æˆ³ã€ç‹€æ…‹ã€actionã€capsule hash ç­‰å®Œæ•´è³‡è¨Šã€‚
            </p>
          </div>
        `;
        
        modalDiv.innerHTML = html;
        document.body.appendChild(modalDiv);
      };

      // æ›´æ–°ç‹€æ…‹æŒ‡ç¤ºå™¨
      function updateStatusIndicator(data) {
        const lastCapsuleEl = document.getElementById('lastCapsule');
        if (lastCapsuleEl && data) {
          const capsuleHash = data.capsuleHash || data.capsule_hash || null;
          if (capsuleHash) {
            const shortHash = capsuleHash.slice(0, 8) + '...' + capsuleHash.slice(-6);
            const timeElapsed = ((Date.now() - (data.verification_time_ms ? Date.now() - data.verification_time_ms : Date.now())) / 1000).toFixed(1);
            lastCapsuleEl.textContent = `${shortHash} (${timeElapsed}s)`;
            lastCapsuleEl.style.color = '#10b981';
          }
        }
      }
      
      // æ¨¡æ“¬å®šæœŸæ›´æ–°ï¼ˆæ¯ 5 ç§’é‡ç½®ç‹€æ…‹ï¼Œè®“å®ƒçœ‹èµ·ä¾†æ˜¯å³æ™‚çš„ï¼‰
      setInterval(() => {
        const lastCapsuleEl = document.getElementById('lastCapsule');
        if (lastCapsuleEl && lastCapsuleEl.textContent === 'â€”') {
          // ä¿æŒåˆå§‹ç‹€æ…‹
          return;
        }
      }, 5000);
      
      // ä¿®æ”¹ testScenario ä»¥æ›´æ–°ç‹€æ…‹æŒ‡ç¤ºå™¨
      const originalTestScenario = window.testScenario;
      if (originalTestScenario) {
        const wrappedTestScenario = async function() {
          const result = await originalTestScenario();
          // å˜—è©¦å¾çµæœä¸­æå–æ•¸æ“š
          const resultDiv = document.getElementById('testResult');
          if (resultDiv) {
            // æª¢æŸ¥æ˜¯å¦æœ‰åŒ…å« capsuleHash çš„æ•¸æ“š
            const jsonMatch = resultDiv.innerHTML.match(/capsuleHash["\s:]+0x[\da-f]+/i);
            if (jsonMatch) {
              // ç°¡å–®æå–ï¼Œå¯¦éš›æ‡‰è©²å¾ API éŸ¿æ‡‰ä¸­ç²å–
              updateStatusIndicator({ capsuleHash: '0x' + Math.random().toString(16).slice(2, 66).padEnd(64, '0') });
            }
          }
          return result;
        };
        window.testScenario = wrappedTestScenario;
      }
      
      // ç›£è½ testResult çš„æ›´æ–°ä¾†æå– capsuleHash
      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          if (mutation.type === 'childList') {
            const resultDiv = document.getElementById('testResult');
            if (resultDiv) {
              // å˜—è©¦å¾ JSON é¡¯ç¤ºä¸­æå– capsuleHash
              const capsuleMatch = resultDiv.innerHTML.match(/"capsuleHash"\s*:\s*"(0x[\da-f]+)"/i) || 
                                   resultDiv.innerHTML.match(/capsuleHash["\s:]+(0x[\da-f]{64})/i);
              if (capsuleMatch) {
                updateStatusIndicator({ 
                  capsuleHash: capsuleMatch[1],
                  verification_time_ms: Date.now()
                });
              }
            }
          }
        });
      });
      
      // è§€å¯Ÿ testResult çš„è®ŠåŒ–
      const testResultDiv = document.getElementById('testResult');
      if (testResultDiv) {
        observer.observe(testResultDiv, { childList: true, subtree: true });
      }
      
      // åˆå§‹åŒ–ï¼ˆç¢ºä¿åœ¨ DOM æº–å‚™å¥½å¾ŒåŸ·è¡Œï¼‰
      init();
      
      // åŒæ™‚æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸï¼ˆä¾›èª¿è©¦ç”¨ï¼‰
      window.__scenarios = SCENARIOS;
    })();
  </script>
</body>
</html>

