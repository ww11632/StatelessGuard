<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>ç§Ÿç´„é›œæ¹Šï½œRWA Housing Governance MVP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Helvetica,Arial;margin:24px;line-height:1.6;background:#f9fafb;}
    .container { max-width:1200px; margin:0 auto; }
    .card{border:1px solid #e5e7eb;border-radius:12px;padding:20px;margin:16px 0;background:white;box-shadow:0 1px 3px rgba(0,0,0,0.1);}
    .card h3 { margin-top:0; color:#1f2937; }
    input,button{font-size:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row>*{flex:1}
    textarea{width:100%;min-height:120px;font-family:ui-monospace,Consolas,Menlo,monospace}
  </style>
</head>
<body>
  <div class="container">
    <div style="margin-bottom:24px;">
      <h1 style="margin:0 0 8px 0; font-size:28px; color:#1f2937;">ğŸ—ï¸ Core Flow ï½œ ç§Ÿç´„é›œæ¹Š</h1>
      <p class="hint" style="color:#6b7280; margin:0; font-size:14px;">ç§Ÿç´„æ–‡ä»¶é›œæ¹Šè¨ˆç®—èˆ‡å¯©è¨ˆè¨˜éŒ„</p>
    </div>

  <div class="card">
    <div class="row">
      <div>
        <label>é¸æ“‡ç§Ÿç´„æª”æ¡ˆï¼ˆPDF/ä»»ä½•æª”ï¼‰</label>
<input id="file" type="file" accept=".pdf,.doc,.docx,.jpg,.png,.jpeg,.heic,.png,.webp" /> 
      </div>
      <div>
        <label>ç°½ç™¼è€…ï¼ˆissuerï¼‰</label>
        <input id="issuer" value="RWA-Housing-Governance-MVP" />
      </div>
    </div>
    <div style="margin-top:12px">
      <button id="btnHash">â‘  è¨ˆç®—é›œæ¹Šä¸¦å¯«å…¥æ—¥èªŒ</button>
      <button id="btnExport">â‘¡ åŒ¯å‡ºæ—¥èªŒï¼ˆaudit_log.jsonlï¼‰</button>
      <button id="btnReceipt" type="button">â‘¢ åŒ¯å‡ºç§Ÿç´„ç°½ç« å›åŸ·</button>

    </div>
  </div>

  <div class="card">
    <label>çµæœ</label>
    <textarea id="out" readonly></textarea>
  </div>

  </div>
  <div id="statusSummary"></div>
  <div id="nav"></div>
  <script src="js/nav.js?v=20251031v4v3"></script>
  <script src="js/statusSummary.js"></script>
  <script>

(function fixJsonlNewlines(){
  const buf = localStorage.getItem('audit_log_jsonl') || '';
  if (buf.includes('\\n{') || buf.includes('}\\n')) {
    localStorage.setItem('audit_log_jsonl', buf.replace(/\\n/g, '\n'));
  }
})();

  const LOG_KEY = 'audit_log_jsonl';
  const nowISO = ()=> new Date().toISOString();

  async function sha256HexBuf(buf){
    const dig = await crypto.subtle.digest('SHA-256', buf);
    return Array.from(new Uint8Array(dig)).map(b=>b.toString(16).padStart(2,'0')).join('');
  }
  function readAuditLines(){
  const buf = localStorage.getItem(LOG_KEY) || '';
  if (!buf) return [];
  const rows = buf.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
  try {
    return rows.map(s => JSON.parse(s));
  } catch (e) {
    // é€²éšä¿éšªï¼šè‹¥ä¸­é€”æœ‰å£è¡Œï¼Œå…ˆæ¨™è¨˜ä¸¦ç•¥éï¼Œé¿å…æ•´å€‹åŠŸèƒ½æ›æ‰
    const good = [];
    for (const s of rows) {
      try { good.push(JSON.parse(s)); } catch(_) { /* å¿½ç•¥å£è¡Œ */ }
    }
    return good;
  }
}
  function appendAudit(o){
    let buf = localStorage.getItem(LOG_KEY) || '';
    buf += (buf && !buf.endsWith('\n')?'\n':'') + JSON.stringify(o) + '\n';
    localStorage.setItem(LOG_KEY, buf);
  }
  async function calcRecordHash(o){
    const keys = ['ts','actor','action','ref','data_hash','prev_hash'];
    const flat = keys.map(k => (o[k]??'')).join('|');
    const enc = new TextEncoder().encode(flat);
    return sha256HexBuf(enc);
  }
  document.getElementById('btnHash').addEventListener('click', async()=>{
    const f = document.getElementById('file').files[0];
    if(!f){ alert('è«‹å…ˆé¸æ“‡æª”æ¡ˆ'); return; }
    const issuer = document.getElementById('issuer').value || 'admin@rwa';
    const buf = await f.arrayBuffer();
    const h = await sha256HexBuf(buf);

    const lines = readAuditLines();
    const prev = lines.length ? await sha256HexBuf(new TextEncoder().encode(JSON.stringify(lines[lines.length-1]))) : null;

    const rec = {
      ts: nowISO(),
      actor: issuer,
      action: 'LEASE_HASHED',
      ref: 'lease:' + f.name,
      data_hash: h,
      prev_hash: prev,
      record_hash: null
    };
    rec.record_hash = await calcRecordHash(rec);
    const sig = `${rec.action}|${rec.ref}|${rec.data_hash}`;
const seen = new Set(lines.map(x => `${x.action}|${x.ref}|${x.data_hash}`));
if (!seen.has(sig)) {
  appendAudit(rec);
}

    document.getElementById('out').value =
      'æª”å: ' + f.name + '\nSHA-256: ' + h + '\nå·²å¯«å…¥æ—¥èªŒä¸€è¡Œï¼ˆLEASE_HASHEDï¼‰';
  });

  document.getElementById('btnExport').addEventListener('click', ()=>{
    const buf = localStorage.getItem(LOG_KEY) || '';
    const blob = new Blob([buf], {type:'application/jsonl;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    const ts = new Date().toISOString().replace(/[-:.TZ]/g,'').slice(0,14);
const who = (document.getElementById('issuer')?.value || 'rwa').replace(/\W+/g,'-');
a.download = `audit_log_${ts}_${who}.jsonl`;

    a.click();
    URL.revokeObjectURL(a.href);
  });
function exportLeaseReceipt(){
  const lines = readAuditLines();
  if(!lines.length){ alert('ç›®å‰é‚„æ²’æœ‰ä»»ä½•å¯©è¨ˆè¨˜éŒ„'); return; }
  const rec = [...lines].reverse().find(x=>x.action==='LEASE_HASHED') || lines[lines.length-1];

  const body = [
    'ã€ç§Ÿç´„é›œæ¹Š ç°½ç« å›åŸ·ã€‘',
    `æ™‚é–“(ts):         ${rec.ts}`,
    `ç°½ç™¼è€…(actor):    ${rec.actor}`,
    `å‹•ä½œ(action):     ${rec.action}`,
    `æŒ‡æ¶‰(ref):        ${rec.ref}`,
    `è³‡æ–™é›œæ¹Š(data):   ${rec.data_hash}`,
    `å‰ä¸€æ‰‹(prev_hash):${rec.prev_hash ?? '(null)'}`,
    `æœ¬è²¼ç´™(record):   ${rec.record_hash}`,
    '',
    'èªªæ˜ï¼šè«‹æ­é… verify.html é©—éˆï¼ˆæ¯ä¸€å¼µè²¼ç´™è¦ç‰½ä½ä¸Šä¸€å¼µï¼‰ã€‚'
  ].join('\n');

  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([body], {type:'text/plain'}));
  a.download = 'lease_receipt.txt';
  a.click();
  URL.revokeObjectURL(a.href);
}
document.getElementById('btnReceipt').addEventListener('click', exportLeaseReceipt);

  </script>
</body>
</html>
