<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>æ’¥æ¬¾å‰æ ¸é©—ï½œRWA Housing Governance MVP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Helvetica,Arial;margin:24px;line-height:1.6;background:#f9fafb;}
    .container { max-width:1200px; margin:0 auto; }
    .card{border:1px solid #e5e7eb;border-radius:12px;padding:20px;margin:16px 0;background:white;box-shadow:0 1px 3px rgba(0,0,0,0.1);}
    .card h3 { margin-top:0; color:#1f2937; }
    textarea{width:100%;min-height:100px;font-family:ui-monospace,Consolas,Menlo,monospace}
    .ok{color:#15803d}.bad{color:#b91c1c}
  </style>
</head>
<body>
  <div class="container">
    <div style="margin-bottom:24px;">
      <h1 style="margin:0 0 8px 0; font-size:28px; color:#1f2937;">ğŸ—ï¸ Core Flow ï½œ æ’¥æ¬¾å‰æ ¸é©—</h1>
      <p class="hint" style="color:#6b7280; margin:0; font-size:14px;">ç§Ÿç´„æª”æ¡ˆèˆ‡å¯©è¨ˆæ—¥èªŒå°ç…§é©—è­‰</p>
    </div>
<!-- ====== æµç¨‹ç²¾éˆï¼ˆèˆ‡ members.html / verify.html åŒæ¬¾ï¼‰ ====== -->
<div class="card" id="flow-wizard">
  <label style="margin-top:0;">æˆ‘è¦æ¸¬è©¦å“ªä¸€æ¢é©—è­‰æµç¨‹ï¼Ÿ</label>
  <div style="display:flex;gap:12px;flex-wrap:wrap;">
    <label><input type="radio" name="flow" value="A" checked> Aï¼šæ’¥æ¬¾å‰æ ¸é©—ï¼ˆç•™åœ¨æœ¬é ï¼‰</label>
    <label><input type="radio" name="flow" value="B"> Bï¼šæˆå“¡ VC ç™¼è¡Œï¼ˆmembers.htmlï¼‰</label>
    <label><input type="radio" name="flow" value="C"> Cï¼šæ—¥èªŒé©—éˆï¼ˆverify.htmlï¼‰</label>
    <label><input type="radio" name="flow" value="E"> Eï¼šæˆ‘é‚„ä¸ç¢ºå®šï¼ˆå…ˆçœ‹æç¤ºï¼‰</label>
  </div>
  <div class="actions" style="margin-top:12px;">
    <button id="btnStartFlow" type="button">é–‹å§‹</button>
    <span id="flowHint" class="hint"></span>
  </div>
</div>

  <div class="card">
    <div>
      <label>ä¸Šå‚³ audit_log.jsonl</label>
      <input id="logfile" type="file" accept=".jsonl,.txt" />
    </div>
    <div style="margin-top:8px">
      <label>ä¸Šå‚³ç§Ÿç´„æª”æ¡ˆï¼ˆPDF/ä»»ä½•ï¼‰</label>
      <input id="leaseFile" type="file" />
    </div>
    <div style="margin-top:12px">
      <button id="btnVerify">é–‹å§‹æ ¸é©—</button>
      <button id="btnReport" disabled>åŒ¯å‡ºæ ¸é©—å ±å‘Š.txt</button>

    </div>
  </div>

  <div class="card">
    <p id="status">å°šæœªæ ¸é©—</p>
    <textarea id="detail" readonly></textarea>
  </div>

  </div>
  <div id="statusSummary"></div>
  <div id="nav"></div>
  <script src="js/nav.js?v=20251031v4v3"></script>
  <script src="js/statusSummary.js"></script>
  <script>
(function initWizard(){
  const start = document.getElementById('btnStartFlow');
  const hint  = document.getElementById('flowHint');
  if (!start) return;

  start.addEventListener('click', () => {
    const v = (document.querySelector('input[name="flow"]:checked')||{}).value || 'A';
    if (v === 'A') {
      // ç•™åœ¨æœ¬é ï¼šçµ¦ä¸€æ­¥ä¸€æ­¥æç¤º
      hint.textContent = 'å…ˆä¸Šå‚³ audit_log.jsonl + ç§Ÿç´„æª”ï¼Œå†æŒ‰ã€Œé–‹å§‹æ ¸é©—ã€ã€‚è‹¥ç¼º record_hash ä¸ç”¨æ“”å¿ƒï¼Œæœ¬é æœƒé€ç­†é‡æ–°è¨ˆç®—é©—éˆã€‚';
      hint.style.color = '#15803d';
    } else if (v === 'B') {
      // èµ°ã€Œæˆå“¡ VC ç™¼è¡Œã€è·¯ç·š
      location.href = 'members.html?guide=from_payout';
    } else if (v === 'C') {
      // èµ°ã€Œæ—¥èªŒé©—éˆã€è·¯ç·š
      location.href = 'verify.html?guide=from_payout';
    } else {
      // Eï¼šå…ˆçœ‹èªªæ˜ï¼Œä¸è·³èµ°
      hint.textContent = 'é€™ä¸‰æ¢è·¯åƒä¸‰æ¢æ•£æ­¥å°å¾‘ï¼šA=æ ¸å°ç§Ÿç´„èˆ‡æ—¥èªŒã€B=å…ˆç™¼ VCã€C=åªé©—æ—¥èªŒï¼›å…ˆæƒ³å¥½ç›®çš„å†å‡ºç™¼ã€‚';
      hint.style.color = '#6b7280';
    }
  });

  // è‹¥å¸¶ guide åƒæ•¸ï¼Œé¡¯ç¤ºå°æç¤ºï¼ˆè·¨é å°è¦½çš„å›è²ï¼‰
  const p = new URLSearchParams(location.search).get('guide');
  if (p) {
    const map = {
      from_members: 'ï¼ˆä¾†è‡ªæˆå“¡ VC ç™¼è¡Œï¼‰ç¾åœ¨è¦æŠŠç§Ÿç´„æª”èˆ‡å¯©è¨ˆæ—¥èªŒæ ¸å°ï¼›ä¸Šå‚³å…©å€‹æª”æ¡ˆå¾Œï¼Œé»ã€Œé–‹å§‹æ ¸é©—ã€ã€‚',
      from_verify : 'ï¼ˆä¾†è‡ªæ—¥èªŒé©—éˆï¼‰ç¾åœ¨è¦æŠŠç§Ÿç´„æª”çš„é›œæ¹Šèˆ‡æ—¥èªŒå°ä¸Šï¼›ä¸Šå‚³å…©å€‹æª”æ¡ˆå¾Œï¼Œé»ã€Œé–‹å§‹æ ¸é©—ã€ã€‚'
    };
    if (document.getElementById('flowHint')) {
      document.getElementById('flowHint').textContent = map[p] || '';
    }
  }
})();

  async function sha256HexBuf(buf){
    const dig = await crypto.subtle.digest('SHA-256', buf);
    return Array.from(new Uint8Array(dig)).map(b=>b.toString(16).padStart(2,'0')).join('');
  }

   function err(x){ console.error(x); alert(x); }
  async function sha256Hex(input){
    const ab = (input instanceof ArrayBuffer) ? input : new TextEncoder().encode(input);
    const d = await crypto.subtle.digest('SHA-256', ab);
    return Array.from(new Uint8Array(d)).map(b=>b.toString(16).padStart(2,'0')).join('');
  }
 
  async function hashOfPrev(rec){ return await sha256Hex(JSON.stringify(rec)); }
  async function calcRecordHash(rec){
    const plain = JSON.stringify({ts:rec.ts,actor:rec.actor,action:rec.action,ref:rec.ref,data_hash:rec.data_hash,prev_hash:rec.prev_hash});
    return await sha256Hex(plain);
  }
  function looksLikeLease(rec){
    // å…¼å®¹ä¸åŒå‘½åï¼šaction/ ref åªè¦å« LEASE / RENT / lease å­—æ¨£å°±ç®—
    const a = String(rec.action||'').toUpperCase();
    const r = String(rec.ref||'').toUpperCase();
    return a.includes('LEASE') || a.includes('RENT') || r.includes('LEASE');
  }

 async function readText(fileInput) {
    const f = fileInput.files[0];
    if (!f) throw 'è«‹å…ˆé¸ audit_log.jsonl';
    return await f.text();
  }

  function parseJsonl(text) {
    return text.trim().split('\n').filter(Boolean).map(JSON.parse);
  }

function downloadText(name, text){
  const blob = new Blob([text], {type:'text/plain'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = name;
  a.click();
  URL.revokeObjectURL(a.href);
}

  document.getElementById('btnVerify').addEventListener('click', async () => {
    try {
      // 1) è®€å…¥å¯©è¨ˆæ—¥èªŒ
      const logText = await readText(document.getElementById('logfile'));
      const rows = parseJsonl(logText);

      // 2) è®€å…¥ç§Ÿç´„æª”æ¡ˆä¸¦ç®— hash
      const lease = document.getElementById('leaseFile').files[0];
      if (!lease) { alert('è«‹å…ˆé¸ç§Ÿç´„æª”'); return; }
      const buf = await lease.arrayBuffer();
      const h = await sha256Hex(buf);
      const ref = 'lease:' + lease.name;

      // 3) é©—è­‰ï¼šæ˜¯å¦å­˜åœ¨ä¸€ç­†ã€ŒLEASE_HASHED + ref + data_hash==hã€
      const hit = rows.some(r => r.action === 'LEASE_HASHED' && r.ref === ref && r.data_hash === h);

if (!hit) {
  const maybe = rows.filter(r => looksLikeLease(r));
  if (maybe.length) {
    console.warn('æ—¥èªŒè£¡æœ‰ Lease é¡å‹ï¼Œä½†æª”åæˆ–é›œæ¹Šä¸å»åˆï¼Œè«‹ç¢ºèªä¸Šå‚³çš„æ˜¯æ­£ç¢ºæª”æ¡ˆã€‚');
  }
}


      // 4) é€ç­†æª¢æŸ¥éˆ prev_hash / record_hash
      const tbody = document.querySelector('#result tbody');
      tbody.innerHTML = '';
      let chainOK = true;
      for (let i = 0; i < rows.length; i++) {
        const r = rows[i];
        const prev = i ? await hashOfPrev(rows[i-1]) : null;   // â†é‡é»
const prev_ok = (r.prev_hash ?? null) === (prev ?? null);

const want = await calcRecordHash(r);                        // â†åŒä¸€å…¬å¼
const rec_ok = r.record_hash === want;

        chainOK = chainOK && prev_ok && rec_ok;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i + 1}</td>
          <td>${r.action}</td>
          <td>${r.ref}</td>
          <td>${prev_ok ? 'âœ”ï¸' : 'âŒ'}</td>
          <td>${rec_ok ? 'âœ”ï¸' : 'âŒ'}</td>`;
        tbody.appendChild(tr);
      }
document.getElementById('status').textContent = chainOK ? 'æ ¸é©—é€šé âœ…' : 'æ ¸é©—å¤±æ•— âŒ';
      document.getElementById('detail').value =
        `ref: ${ref}\nSHA-256: ${h}\næ‰¾åˆ°å°æ‡‰è¨˜éŒ„: ${hit ? 'YES' : 'NO'}`;
      document.getElementById('summary').textContent =
        (chainOK ? 'æ•´æœ¬é©—é–é€šé âœ…' : 'æ•´æœ¬é©—é–å¤±æ•— âŒ') + `ï¼ˆå…± ${rows.length} ç­†ï¼‰`;
   // åœ¨æ–°ç›£è½å™¨å…§éƒ¨æ ¸é©—å®Œæˆå¾Œ
const linesOut = [];
linesOut.push(`[æ ¸é©—æ™‚é–“] ${new Date().toISOString()}`);
linesOut.push(`[ç§Ÿç´„æª”å] ${lease.name}`);
linesOut.push(`[SHA-256] ${h}`);
linesOut.push(`[æ˜¯å¦å‘½ä¸­ LEASE_HASHED] ${hit ? 'YES' : 'NO'}`);
linesOut.push(`[éˆæ¢ç¸½çµ] ${chainOK ? 'é€šé' : 'å¤±æ•—'}ï¼ˆå…± ${rows.length} ç­†ï¼‰`);
linesOut.push(`\n# é€ç­†æª¢æŸ¥`);
for (let i = 0; i < rows.length; i++) {
  const r = rows[i];
const prev = i ? await hashOfPrev(rows[i-1]) : null;
  const prev_ok = (r.prev_hash || null) === (prev || null);
const want = await calcRecordHash(r);
  const rec_ok = r.record_hash === want;
  linesOut.push(`${i+1}. action=${r.action} ref=${r.ref} prev_hash:${prev_ok?'OK':'BAD'} record_hash:${rec_ok?'OK':'BAD'}`);
}
document.getElementById('btnReport').disabled = false;
document.getElementById('btnReport').onclick = () => downloadText(`verify_${lease.name}.txt`, linesOut.join('\n'));
  
    } catch (e) {
      alert(e);
    }
});
  </script>
  <div style="margin-top:12px">é©—è­‰æ‘˜è¦ï¼š<strong id="summary">å°šæœªé©—è­‰</strong></div>
<table id="result" border="1" style="margin-top:8px;border-collapse:collapse">
  <thead>
    <tr>
      <th>#</th><th>action</th><th>ref</th><th>prev_hash âœ”</th><th>record_hash âœ”</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

</body>
</html>
